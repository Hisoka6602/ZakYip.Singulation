<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:viewmodels="clr-namespace:ZakYip.Singulation.MauiApp.ViewModels"
             xmlns:services="clr-namespace:ZakYip.Singulation.MauiApp.Services"
             xmlns:controls="clr-namespace:ZakYip.Singulation.MauiApp.Controls"
             x:Class="ZakYip.Singulation.MauiApp.Views.ModuleGridPage"
             x:DataType="viewmodels:ModuleGridViewModel"
             Title="å•ä»¶åˆ†ç¦»æ¨¡å—">

    <Grid>
        <ScrollView>
            <Grid Padding="10">
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto" />
                    <RowDefinition Height="Auto" />
                    <RowDefinition Height="*" />
                </Grid.RowDefinitions>

                <!-- æ ‡é¢˜æ  -->
                <Frame Grid.Row="0" 
                       Padding="15" 
                       Margin="0,0,0,10"
                       BackgroundColor="#2196F3"
                       CornerRadius="8"
                       HasShadow="True">
                    <Grid ColumnDefinitions="*,Auto" ColumnSpacing="10">
                        <Label Grid.Column="0"
                               Text="å•ä»¶åˆ†ç¦»æ¨¡å—ç½‘æ ¼"
                               FontSize="20"
                               FontAttributes="Bold"
                               TextColor="White"
                               VerticalOptions="Center" />
                        <Button Grid.Column="1"
                                Text="ðŸ”„ åˆ·æ–°"
                                Command="{Binding RefreshModulesCommand}"
                                BackgroundColor="White"
                                TextColor="#2196F3"
                                CornerRadius="8"
                                Padding="15,8" />
                    </Grid>
                </Frame>

                <!-- ç»Ÿè®¡ä¿¡æ¯ -->
                <Frame Grid.Row="1" 
                       Padding="15" 
                       Margin="0,0,0,10"
                       BackgroundColor="#F5F5F5"
                       CornerRadius="8">
                    <Grid ColumnDefinitions="*,*,*,*" ColumnSpacing="10">
                        <VerticalStackLayout Grid.Column="0" Spacing="4">
                            <Label Text="æ€»æ•°" FontSize="12" TextColor="Gray" HorizontalTextAlignment="Center" />
                            <Label Text="{Binding TotalCount}" FontSize="18" FontAttributes="Bold" HorizontalTextAlignment="Center" />
                        </VerticalStackLayout>
                        <VerticalStackLayout Grid.Column="1" Spacing="4">
                            <Label Text="è¿è¡Œä¸­" FontSize="12" TextColor="Green" HorizontalTextAlignment="Center" />
                            <Label Text="{Binding RunningCount}" FontSize="18" FontAttributes="Bold" TextColor="Green" HorizontalTextAlignment="Center" />
                        </VerticalStackLayout>
                        <VerticalStackLayout Grid.Column="2" Spacing="4">
                            <Label Text="ç©ºé—²" FontSize="12" TextColor="Gray" HorizontalTextAlignment="Center" />
                            <Label Text="{Binding IdleCount}" FontSize="18" FontAttributes="Bold" HorizontalTextAlignment="Center" />
                        </VerticalStackLayout>
                        <VerticalStackLayout Grid.Column="3" Spacing="4">
                            <Label Text="é”™è¯¯" FontSize="12" TextColor="Red" HorizontalTextAlignment="Center" />
                            <Label Text="{Binding ErrorCount}" FontSize="18" FontAttributes="Bold" TextColor="Red" HorizontalTextAlignment="Center" />
                        </VerticalStackLayout>
                    </Grid>
                </Frame>

                <!-- æ¨¡å—ç½‘æ ¼ - ä½¿ç”¨CollectionViewå®žçŽ°è™šæ‹ŸåŒ– -->
                <CollectionView Grid.Row="2"
                                ItemsSource="{Binding Modules}"
                                SelectionMode="Single"
                                SelectedItem="{Binding SelectedModule}"
                                SelectionChangedCommand="{Binding ModuleSelectedCommand}">
                    <CollectionView.ItemsLayout>
                        <GridItemsLayout Orientation="Vertical"
                                         Span="{Binding GridColumns}"
                                         HorizontalItemSpacing="2"
                                         VerticalItemSpacing="2" />
                    </CollectionView.ItemsLayout>
                    <CollectionView.ItemTemplate>
                        <DataTemplate x:DataType="services:SingulationModule">
                            <controls:GridModuleView />
                        </DataTemplate>
                    </CollectionView.ItemTemplate>
                    <CollectionView.EmptyView>
                        <VerticalStackLayout HorizontalOptions="Center" 
                                           VerticalOptions="Center" 
                                           Spacing="10"
                                           Padding="20">
                            <Label Text="ðŸ“¦"
                                   FontSize="48"
                                   HorizontalOptions="Center" />
                            <Label Text="æš‚æ— æ¨¡å—æ•°æ®"
                                   FontSize="16"
                                   TextColor="Gray"
                                   HorizontalOptions="Center" />
                            <Label Text="ç‚¹å‡»åˆ·æ–°æŒ‰é’®åŠ è½½æ¨¡å—"
                                   FontSize="14"
                                   TextColor="Gray"
                                   HorizontalOptions="Center" />
                        </VerticalStackLayout>
                    </CollectionView.EmptyView>
                </CollectionView>
            </Grid>
        </ScrollView>

        <!-- åŠ è½½æŒ‡ç¤ºå™¨ -->
        <ActivityIndicator IsRunning="{Binding IsLoading}"
                          IsVisible="{Binding IsLoading}"
                          Color="#2196F3"
                          WidthRequest="50"
                          HeightRequest="50"
                          HorizontalOptions="Center"
                          VerticalOptions="Center" />
        
        <!-- é€šçŸ¥è¦†ç›–å±‚ -->
        <controls:NotificationOverlay 
            VerticalOptions="Start"
            HorizontalOptions="Fill"
            Margin="0,10,0,0"
            ZIndex="1000" />
    </Grid>
</ContentPage>
