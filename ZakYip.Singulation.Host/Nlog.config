<?xml version="1.0" encoding="utf-8" ?>
<Nlog xmlns="http://www.nlog-project.org/schemas/NLog.xsd"
      xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">
	<targets>

		<!-- 异步包装，避免阻塞业务线程 -->
		<target xsi:type="AsyncWrapper" name="byCategoryAsync" overflowAction="Block" queueLimit="50000">
			<!-- 按 Source 分文件；若没有 Source，则用 logger 名称；同时做文件名字符清洗 -->
			<target xsi:type="File" name="byCategory"
					fileName="${basedir}/logs/${when:when='${event-properties:Source}'!='':inner=${replace:regex=true:searchFor=[^a-zA-Z0-9_:\\-\\.]+:replaceWith=_:inner=${event-properties:Source}}:else=${replace:regex=true:searchFor=[^a-zA-Z0-9_:\\-\\.]+:replaceWith=_:inner=${logger}}}-${shortdate}.log"
					archiveFileName="${basedir}/logs/archive/${when:when='${event-properties:Source}'!='':inner=${event-properties:Source}:else=${logger}}-${shortdate}-{#}.log"
					archiveNumbering="Rolling"
					archiveEvery="Day"
					maxArchiveFiles="14"
					concurrentWrites="true"
					keepFileOpen="false"
					encoding="utf-8"
					layout="${longdate}|${uppercase:${level}}|${logger}|msg=${message}
src=${event-properties:Source} axis=${event-properties:Axis} state=${event-properties:State} len=${event-properties:Len}
${exception:format=ToString}" />
		</target>

		<!-- 错误单独文件（异步） -->
		<target xsi:type="AsyncWrapper" name="errorsAsync" overflowAction="Block" queueLimit="20000">
			<target xsi:type="File" name="errors"
					fileName="${basedir}/logs/errors-${shortdate}.log"
					archiveFileName="${basedir}/logs/archive/errors-${shortdate}-{#}.log"
					archiveNumbering="Rolling"
					archiveEvery="Day"
					maxArchiveFiles="30"
					concurrentWrites="true"
					keepFileOpen="false"
					encoding="utf-8"
					layout="${longdate}|${uppercase:${level}}|${logger}|src=${event-properties:Source}|axis=${event-properties:Axis}|state=${event-properties:State}|len=${event-properties:Len}|msg=${message} ${exception:format=ToString}" />
		</target>
	</targets>

	<rules>
		<!-- Error 及以上优先落 errors -->
		<logger minlevel="Error" writeTo="errorsAsync" final="true" />
		<!-- 其余等级走按 Source/Logger 分文件 -->
		<logger minlevel="Trace" writeTo="byCategoryAsync" />
	</rules>
</Nlog>