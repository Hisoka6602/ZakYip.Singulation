name: Anti-Duplication Check

on:
  pull_request:
    branches: [ main, develop ]
    paths:
      - '**.cs'
  push:
    branches: [ main, develop ]
    paths:
      - '**.cs'

jobs:
  check-duplication:
    name: ä»£ç é‡å¤æ£€æµ‹
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '8.0.x'
    
    - name: Make scripts executable
      run: chmod +x tools/*.sh
    
    - name: Run duplication check
      id: duplication-check
      run: |
        ./tools/check-duplication.sh
      continue-on-error: true
    
    - name: Check analysis results
      run: |
        dotnet tool install --global dotnet-counters || true
        
        # ç¼–è¯‘é¡¹ç›®ä»¥è¿è¡Œåˆ†æå™¨
        for project in $(find . -name "*.csproj" -not -path "*/obj/*" -not -path "*/bin/*" -not -path "*MauiApp*"); do
          echo "åˆ†æé¡¹ç›®: $project"
          dotnet build "$project" \
            -c Release \
            -p:RunAnalyzers=true \
            -p:TreatWarningsAsErrors=false \
            -p:WarningLevel=4 \
            || true
        done
    
    - name: Generate summary
      if: always()
      run: |
        echo "## ğŸ›¡ï¸ å½±åˆ†èº«é˜²çº¿æ£€æŸ¥ç»“æœ" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        if [ "${{ steps.duplication-check.outcome }}" == "success" ]; then
          echo "âœ… **ä»£ç é‡å¤æ£€æŸ¥é€šè¿‡**" >> $GITHUB_STEP_SUMMARY
        else
          echo "âš ï¸ **å‘ç°ä»£ç é‡å¤é—®é¢˜**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "è¯·æŸ¥çœ‹ä¸Šæ–¹æ—¥å¿—äº†è§£è¯¦æƒ…ï¼Œå¹¶å‚è€ƒ \`ANTI_DUPLICATION_DEFENSE.md\` æ–‡æ¡£è¿›è¡Œæ”¹è¿›ã€‚" >> $GITHUB_STEP_SUMMARY
        fi
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "---" >> $GITHUB_STEP_SUMMARY
        echo "ğŸ“š ç›¸å…³æ–‡æ¡£:" >> $GITHUB_STEP_SUMMARY
        echo "- [å½±åˆ†èº«é˜²çº¿æ–‡æ¡£](../blob/main/ANTI_DUPLICATION_DEFENSE.md)" >> $GITHUB_STEP_SUMMARY
        echo "- [å¿«é€Ÿä¿®å¤æŒ‡å—](../blob/main/QUICK_FIX_GUIDE.md)" >> $GITHUB_STEP_SUMMARY
        echo "- [é—®é¢˜æ£€æµ‹æŠ¥å‘Š](../blob/main/ISSUE_DETECTION_REPORT.md)" >> $GITHUB_STEP_SUMMARY
    
    - name: Fail if critical issues found
      if: steps.duplication-check.outcome == 'failure'
      run: |
        echo "::error::å‘ç°ä¸¥é‡çš„ä»£ç é‡å¤é—®é¢˜ï¼Œè¯·ä¿®å¤åå†æäº¤"
        exit 1
