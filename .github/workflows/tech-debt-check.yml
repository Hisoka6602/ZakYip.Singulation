name: Technical Debt Check

on:
  pull_request:
    branches: [ main, develop ]
  push:
    branches: [ main, develop ]

jobs:
  check-tech-debt:
    name: æŠ€æœ¯å€ºåŠ¡æ£€æŸ¥
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: Make scripts executable
      run: chmod +x tools/*.sh
    
    - name: Check if TECHNICAL_DEBT.md exists
      id: check-file
      run: |
        if [ ! -f "TECHNICAL_DEBT.md" ]; then
          echo "âŒ é”™è¯¯: æ‰¾ä¸åˆ° TECHNICAL_DEBT.md"
          echo "è¯·åˆ›å»ºæŠ€æœ¯å€ºåŠ¡è¿½è¸ªæ–‡æ¡£"
          exit 1
        fi
        echo "âœ… æŠ€æœ¯å€ºåŠ¡æ–‡æ¡£å­˜åœ¨"
    
    - name: Check for P0 (Critical) technical debt
      id: check-p0
      run: |
        echo "æ£€æŸ¥å…³é”®(P0)æŠ€æœ¯å€ºåŠ¡..."
        P0_COUNT=$(grep -c "ä¼˜å…ˆçº§\*\*: P0" TECHNICAL_DEBT.md 2>/dev/null || echo "0")
        
        if [ "$P0_COUNT" -gt 0 ]; then
          echo "âŒ å‘ç° $P0_COUNT ä¸ªå…³é”®(P0)æŠ€æœ¯å€ºåŠ¡"
          echo "p0_found=true" >> $GITHUB_OUTPUT
          echo "p0_count=$P0_COUNT" >> $GITHUB_OUTPUT
          
          # æå–P0é¡¹ç›®
          echo "## âŒ å…³é”®æŠ€æœ¯å€ºåŠ¡ (P0)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "å‘ç° $P0_COUNT ä¸ªå¿…é¡»å¤„ç†çš„å…³é”®æŠ€æœ¯å€ºåŠ¡ï¼š" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          awk '/^### TD-[0-9]+:/ {found=1; item=$0; next} 
               found && /\*\*ä¼˜å…ˆçº§\*\*: P0/ {
                 print item; 
                 found=0
               }' TECHNICAL_DEBT.md >> $GITHUB_STEP_SUMMARY
          
          exit 1
        else
          echo "âœ… æ— å…³é”®æŠ€æœ¯å€ºåŠ¡"
          echo "p0_found=false" >> $GITHUB_OUTPUT
          echo "p0_count=0" >> $GITHUB_OUTPUT
        fi
      continue-on-error: true
    
    - name: Calculate technical debt health score
      id: health-score
      run: |
        echo "è®¡ç®—æŠ€æœ¯å€ºåŠ¡å¥åº·åº¦..."
        
        P0=$(grep -c "ä¼˜å…ˆçº§\*\*: P0" TECHNICAL_DEBT.md 2>/dev/null || echo "0")
        P1=$(grep -c "ä¼˜å…ˆçº§\*\*: P1" TECHNICAL_DEBT.md 2>/dev/null || echo "0")
        P2=$(grep -c "ä¼˜å…ˆçº§\*\*: P2" TECHNICAL_DEBT.md 2>/dev/null || echo "0")
        P3=$(grep -c "ä¼˜å…ˆçº§\*\*: P3" TECHNICAL_DEBT.md 2>/dev/null || echo "0")
        
        PENDING=$(grep -c "çŠ¶æ€\*\*: â³ å¾…å¤„ç†" TECHNICAL_DEBT.md 2>/dev/null || echo "0")
        IN_PROGRESS=$(grep -c "çŠ¶æ€\*\*: ğŸ”„ è¿›è¡Œä¸­" TECHNICAL_DEBT.md 2>/dev/null || echo "0")
        DONE=$(grep -c "çŠ¶æ€\*\*: âœ… å·²å®Œæˆ" TECHNICAL_DEBT.md 2>/dev/null || echo "0")
        
        HEALTH=$((100 - P0 * 25 - P1 * 10 - P2 * 3 - P3 * 1))
        
        echo "health=$HEALTH" >> $GITHUB_OUTPUT
        echo "p0=$P0" >> $GITHUB_OUTPUT
        echo "p1=$P1" >> $GITHUB_OUTPUT
        echo "p2=$P2" >> $GITHUB_OUTPUT
        echo "p3=$P3" >> $GITHUB_OUTPUT
        echo "pending=$PENDING" >> $GITHUB_OUTPUT
        echo "in_progress=$IN_PROGRESS" >> $GITHUB_OUTPUT
        echo "done=$DONE" >> $GITHUB_OUTPUT
        
        echo "æŠ€æœ¯å€ºåŠ¡å¥åº·åº¦: $HEALTH/100"
        echo "P0: $P0, P1: $P1, P2: $P2, P3: $P3"
        echo "å¾…å¤„ç†: $PENDING, è¿›è¡Œä¸­: $IN_PROGRESS, å·²å®Œæˆ: $DONE"
    
    - name: Check for high priority (P1) pending debt
      id: check-p1
      run: |
        echo "æ£€æŸ¥é«˜ä¼˜å…ˆçº§(P1)å¾…å¤„ç†æŠ€æœ¯å€ºåŠ¡..."
        
        # æå–P1ä¸”çŠ¶æ€ä¸ºå¾…å¤„ç†çš„é¡¹
        P1_PENDING=$(awk '
          /^### TD-[0-9]+:/ {item=$0; is_p1=0; is_pending=0}
          /\*\*ä¼˜å…ˆçº§\*\*: P1/ {is_p1=1}
          /\*\*çŠ¶æ€\*\*: â³ å¾…å¤„ç†/ {is_pending=1}
          is_p1 && is_pending {count++; is_p1=0; is_pending=0}
          END {print count+0}
        ' TECHNICAL_DEBT.md)
        
        if [ "$P1_PENDING" -gt 0 ]; then
          echo "âš ï¸  å‘ç° $P1_PENDING ä¸ªå¾…å¤„ç†çš„é«˜ä¼˜å…ˆçº§(P1)æŠ€æœ¯å€ºåŠ¡"
          echo "p1_pending=$P1_PENDING" >> $GITHUB_OUTPUT
        else
          echo "âœ… æ— å¾…å¤„ç†çš„é«˜ä¼˜å…ˆçº§æŠ€æœ¯å€ºåŠ¡"
          echo "p1_pending=0" >> $GITHUB_OUTPUT
        fi
    
    - name: Generate summary
      if: always()
      run: |
        echo "## ğŸ” æŠ€æœ¯å€ºåŠ¡æ£€æŸ¥ç»“æœ" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        # å¥åº·åº¦
        HEALTH="${{ steps.health-score.outputs.health }}"
        
        echo "### æŠ€æœ¯å€ºåŠ¡å¥åº·åº¦: $HEALTH/100" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        if [ "$HEALTH" -ge 90 ]; then
          echo "âœ… **è¯„çº§: ä¼˜ç§€**" >> $GITHUB_STEP_SUMMARY
        elif [ "$HEALTH" -ge 75 ]; then
          echo "âœ… **è¯„çº§: è‰¯å¥½**" >> $GITHUB_STEP_SUMMARY
        elif [ "$HEALTH" -ge 60 ]; then
          echo "âš ï¸ **è¯„çº§: ä¸€èˆ¬**" >> $GITHUB_STEP_SUMMARY
        elif [ "$HEALTH" -ge 45 ]; then
          echo "ğŸ”´ **è¯„çº§: éœ€æ”¹è¿›**" >> $GITHUB_STEP_SUMMARY
        else
          echo "â›” **è¯„çº§: å±é™©**" >> $GITHUB_STEP_SUMMARY
        fi
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### æŠ€æœ¯å€ºåŠ¡ç»Ÿè®¡" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "| ä¼˜å…ˆçº§ | æ•°é‡ |" >> $GITHUB_STEP_SUMMARY
        echo "|--------|------|" >> $GITHUB_STEP_SUMMARY
        echo "| P0 (å…³é”®) | ${{ steps.health-score.outputs.p0 }} |" >> $GITHUB_STEP_SUMMARY
        echo "| P1 (é«˜) | ${{ steps.health-score.outputs.p1 }} |" >> $GITHUB_STEP_SUMMARY
        echo "| P2 (ä¸­) | ${{ steps.health-score.outputs.p2 }} |" >> $GITHUB_STEP_SUMMARY
        echo "| P3 (ä½) | ${{ steps.health-score.outputs.p3 }} |" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "| çŠ¶æ€ | æ•°é‡ |" >> $GITHUB_STEP_SUMMARY
        echo "|------|------|" >> $GITHUB_STEP_SUMMARY
        echo "| â³ å¾…å¤„ç† | ${{ steps.health-score.outputs.pending }} |" >> $GITHUB_STEP_SUMMARY
        echo "| ğŸ”„ è¿›è¡Œä¸­ | ${{ steps.health-score.outputs.in_progress }} |" >> $GITHUB_STEP_SUMMARY
        echo "| âœ… å·²å®Œæˆ | ${{ steps.health-score.outputs.done }} |" >> $GITHUB_STEP_SUMMARY
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "---" >> $GITHUB_STEP_SUMMARY
        echo "ğŸ“š æŸ¥çœ‹å®Œæ•´æŠ€æœ¯å€ºåŠ¡åˆ—è¡¨: [TECHNICAL_DEBT.md](../blob/${{ github.sha }}/TECHNICAL_DEBT.md)" >> $GITHUB_STEP_SUMMARY
    
    - name: Fail if P0 exists
      if: steps.check-p0.outputs.p0_found == 'true'
      run: |
        echo "::error::å‘ç° ${{ steps.check-p0.outputs.p0_count }} ä¸ªå…³é”®(P0)æŠ€æœ¯å€ºåŠ¡ï¼Œå¿…é¡»å…ˆå¤„ç†"
        exit 1
    
    - name: Warn if P1 pending
      if: steps.check-p1.outputs.p1_pending > 0
      run: |
        echo "::warning::å‘ç° ${{ steps.check-p1.outputs.p1_pending }} ä¸ªå¾…å¤„ç†çš„é«˜ä¼˜å…ˆçº§(P1)æŠ€æœ¯å€ºåŠ¡ï¼Œå»ºè®®åœ¨æ­¤PRä¸­å¤„ç†"
