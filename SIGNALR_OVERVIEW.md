# SignalR ç³»ç»Ÿæ¦‚è§ˆ

**å¿«é€Ÿå‚è€ƒæŒ‡å—** | **æ—¥æœŸ**: 2025-10-30

---

## ğŸ“Š ç³»ç»Ÿæ¶æ„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        å®¢æˆ·ç«¯å±‚ (MauiApp)                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚  SignalRClientFactory                                           â”‚
â”‚  â”œâ”€ HubConnection (è‡ªåŠ¨é‡è¿: 0s, 2s, 10s)                       â”‚
â”‚  â”œâ”€ å»¶è¿Ÿç›‘æµ‹ (Ping æ¯5ç§’)                                        â”‚
â”‚  â”œâ”€ äº‹ä»¶è®¢é˜… (MessageReceived, SpeedChangedç­‰)                  â”‚
â”‚  â””â”€ è¿æ¥çŠ¶æ€ç®¡ç† (Reconnecting, Connected, Disconnected)        â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â†• SignalR WebSocket
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        æœåŠ¡ç«¯å±‚ (Host)                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚  EventsHub (/hubs/events)                                       â”‚
â”‚  â”œâ”€ Join(channel) - åŠ å…¥é¢‘é“ç»„                                   â”‚
â”‚  â”œâ”€ Leave(channel) - ç¦»å¼€é¢‘é“ç»„                                  â”‚
â”‚  â””â”€ Ping() - å¿ƒè·³æ£€æµ‹                                           â”‚
â”‚                                                                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚  SignalRRealtimeNotifier (IRealtimeNotifier å®ç°)               â”‚
â”‚  â”œâ”€ PublishAsync(channel, payload) - å‘å¸ƒæ¶ˆæ¯                    â”‚
â”‚  â”œâ”€ PublishDeviceAsync(payload) - è®¾å¤‡æ¶ˆæ¯ (/device)            â”‚
â”‚  â”œâ”€ PublishVisionAsync(payload) - è§†è§‰æ¶ˆæ¯ (/vision)            â”‚
â”‚  â””â”€ PublishErrorAsync(payload) - é”™è¯¯æ¶ˆæ¯ (/errors)             â”‚
â”‚           â†“ TryWrite (éé˜»å¡)                                    â”‚
â”‚  Channel<SignalRQueueItem> (50,000å®¹é‡, DropOldestç­–ç•¥)         â”‚
â”‚           â†“ ReadAllAsync                                         â”‚
â”‚  RealtimeDispatchService (åå°æœåŠ¡)                              â”‚
â”‚  â”œâ”€ å¯¹è±¡æ± : MessageEnvelope                                     â”‚
â”‚  â”œâ”€ æ–­è·¯å™¨: 5æ¬¡å¤±è´¥åæ‰“å¼€, 30ç§’åé‡è¯•                            â”‚
â”‚  â”œâ”€ ç›‘æ§: é˜Ÿåˆ—æ·±åº¦, æ¶ˆæ¯ç»Ÿè®¡                                     â”‚
â”‚  â””â”€ å¹¿æ’­: SendAsync("event", envelope)                          â”‚
â”‚                                                                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚  SignalRHealthCheck                                             â”‚
â”‚  â”œâ”€ é˜Ÿåˆ—æ·±åº¦æ£€æŸ¥ (>40,000 â†’ Degraded)                           â”‚
â”‚  â”œâ”€ å¤±è´¥ç‡æ£€æŸ¥ (>10% â†’ Unhealthy)                               â”‚
â”‚  â””â”€ ç»Ÿè®¡æ•°æ®æš´éœ²                                                â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â†• IRealtimeNotifier
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    ä¸šåŠ¡å±‚ (Infrastructure)                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚  IoStatusWorker        â†’ PublishAsync("/sys", ioStatus)         â”‚
â”‚  LogEventPump          â†’ PublishAsync("/sys", logEvents)        â”‚
â”‚  TransportEventPump    â†’ PublishVisionAsync(visionData)         â”‚
â”‚  SpeedFrameWorker      â†’ PublishAsync("/sys", speedChange)      â”‚
â”‚  SafetyPipeline        â†’ PublishErrorAsync(safetyEvent)         â”‚
â”‚  SafetyIsolator        â†’ PublishErrorAsync(isolationEvent)      â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ”‘ æ ¸å¿ƒæ¦‚å¿µ

### é¢‘é“ (Channel)

| é¢‘é“åç§° | ç”¨é€” | å‘å¸ƒè€… |
|---------|------|-------|
| `/sys` | ç³»ç»Ÿçº§æ¶ˆæ¯ | IoStatusWorker, LogEventPump, SpeedFrameWorker |
| `/device` | è®¾å¤‡æ¶ˆæ¯ | TransportEventPump |
| `/vision` | è§†è§‰æ¶ˆæ¯ | TransportEventPump |
| `/errors` | é”™è¯¯å’Œå®‰å…¨æ¶ˆæ¯ | SafetyPipeline, SafetyIsolator |

### æ¶ˆæ¯æµè½¬

```
ä¸šåŠ¡é€»è¾‘
   â†“ PublishAsync (éé˜»å¡)
Channelé˜Ÿåˆ— (50,000å®¹é‡)
   â†“ RealtimeDispatchService
MessageEnvelope (å¯¹è±¡æ± )
   â†“ æ–­è·¯å™¨æ£€æŸ¥
SignalR Hub
   â†“ WebSocket
å®¢æˆ·ç«¯è®¢é˜…è€…
```

### æ¶ˆæ¯æ ¼å¼

```json
{
  "v": 1,                      // ç‰ˆæœ¬å·
  "type": "IoStatusChanged",   // æ¶ˆæ¯ç±»å‹
  "ts": "2025-10-30T10:00:00", // æ—¶é—´æˆ³
  "channel": "/sys",           // é¢‘é“
  "data": { ... },             // å®é™…æ•°æ®
  "traceId": "trace-abc-123",  // è¿½è¸ªID
  "seq": 12345                 // åºåˆ—å·
}
```

---

## ğŸ“ˆ æ€§èƒ½æŒ‡æ ‡

### å½“å‰é…ç½®

| æŒ‡æ ‡ | å€¼ | è¯´æ˜ |
|------|---|------|
| é˜Ÿåˆ—å®¹é‡ | 50,000 | æ¶ˆæ¯ç¼“å­˜ä¸Šé™ |
| èƒŒå‹ç­–ç•¥ | DropOldest | é˜Ÿåˆ—æ»¡æ—¶ä¸¢å¼ƒæ—§æ¶ˆæ¯ |
| å¯¹è±¡æ±  | MessageEnvelope | å‡å°‘GCå‹åŠ› |
| æ–­è·¯å™¨é˜ˆå€¼ | 5æ¬¡å¤±è´¥ | ä¿æŠ¤ç³»ç»Ÿèµ„æº |
| æ–­è·¯å™¨è¶…æ—¶ | 30ç§’ | é‡è¯•ç­‰å¾…æ—¶é—´ |
| ç›‘æ§é—´éš” | 10ç§’ | é˜Ÿåˆ—æ·±åº¦æ£€æŸ¥ |

### å¥åº·çŠ¶æ€

```
Healthy    : é˜Ÿåˆ— < 40,000 ä¸” å¤±è´¥ç‡ < 10%
Degraded   : é˜Ÿåˆ— > 40,000
Unhealthy  : å¤±è´¥ç‡ > 10%
```

---

## âœ… å·²å®ç°åŠŸèƒ½

- [x] å®æ—¶æ¶ˆæ¯æ¨é€
- [x] é¢‘é“è®¢é˜…ç®¡ç†
- [x] è‡ªåŠ¨é‡è¿æœºåˆ¶
- [x] å¿ƒè·³ä¸å»¶è¿Ÿç›‘æµ‹
- [x] æ¶ˆæ¯åºåˆ—å·
- [x] å¯¹è±¡æ± ä¼˜åŒ–
- [x] æ–­è·¯å™¨ä¿æŠ¤
- [x] å¥åº·æ£€æŸ¥
- [x] é˜Ÿåˆ—ç›‘æ§
- [x] å¼‚å¸¸å¤„ç†ç»†åŒ–

---

## âš ï¸ æœªå®ç°åŠŸèƒ½

- [ ] èº«ä»½éªŒè¯ä¸æˆæƒ
- [ ] é€Ÿç‡é™åˆ¶
- [ ] æ¶ˆæ¯å¤§å°é™åˆ¶
- [ ] æ¶ˆæ¯å‹ç¼©
- [ ] æ¶ˆæ¯æŒä¹…åŒ–
- [ ] åŒå‘é€šä¿¡
- [ ] è¯¦ç»†æ€§èƒ½æŒ‡æ ‡ (Metrics)

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

| æ–‡æ¡£ | æè¿° |
|-----|------|
| [SIGNALRè¦†ç›–å†…å®¹ä¸ä¼˜åŒ–æ€»ç»“.md](./SIGNALRè¦†ç›–å†…å®¹ä¸ä¼˜åŒ–æ€»ç»“.md) | ğŸ“– **å®Œæ•´ä¸­æ–‡æ€»ç»“** - æ¨èé˜…è¯» |
| [SIGNALR_IMPLEMENTATION_ANALYSIS.md](./SIGNALR_IMPLEMENTATION_ANALYSIS.md) | è¯¦ç»†æŠ€æœ¯åˆ†æï¼ˆè‹±æ–‡ï¼‰ |
| [SIGNALR_OPTIMIZATION_SUMMARY.md](./SIGNALR_OPTIMIZATION_SUMMARY.md) | ä¼˜åŒ–å®æ–½æ€»ç»“ï¼ˆè‹±æ–‡ï¼‰ |
| [SIGNALRä¼˜åŒ–å»ºè®®æ‘˜è¦.md](./SIGNALRä¼˜åŒ–å»ºè®®æ‘˜è¦.md) | å¿«é€Ÿå‚è€ƒï¼ˆä¸­æ–‡ï¼‰ |
| [SIGNALR_CLIENT_RETRY_POLICY.md](./SIGNALR_CLIENT_RETRY_POLICY.md) | å®¢æˆ·ç«¯é‡è¿ç­–ç•¥æŒ‡å— |

---

## ğŸš€ å¿«é€Ÿå¼€å§‹

### æœåŠ¡ç«¯ä½¿ç”¨

```csharp
// æ³¨å…¥ IRealtimeNotifier
public class MyService {
    private readonly IRealtimeNotifier _notifier;
    
    public MyService(IRealtimeNotifier notifier) {
        _notifier = notifier;
    }
    
    // å‘å¸ƒæ¶ˆæ¯
    public async Task SendNotification() {
        await _notifier.PublishAsync("/sys", new {
            message = "Hello SignalR!"
        });
    }
}
```

### å®¢æˆ·ç«¯ä½¿ç”¨

```csharp
// åˆ›å»ºè¿æ¥
var factory = new SignalRClientFactory("https://localhost:5005");
var connection = await factory.GetOrCreateHubConnectionAsync();

// è®¢é˜…é¢‘é“
await connection.InvokeAsync("Join", "/sys");

// ç›‘å¬äº‹ä»¶
connection.On<MessageEnvelope>("event", (envelope) => {
    Console.WriteLine($"Received: {envelope.Type} on {envelope.Channel}");
});
```

---

**æ–‡æ¡£ç‰ˆæœ¬**: 1.0  
**æœ€åæ›´æ–°**: 2025-10-30  
**ç»´æŠ¤è€…**: GitHub Copilot Agent
