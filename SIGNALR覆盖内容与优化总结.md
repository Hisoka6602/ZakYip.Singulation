# SignalR è¦†ç›–å†…å®¹ä¸ä¼˜åŒ–æ€»ç»“

**æ–‡æ¡£æ—¥æœŸ**: 2025-10-30  
**æ–‡æ¡£ç‰ˆæœ¬**: 1.0  
**çŠ¶æ€**: ç»¼åˆåˆ†ææŠ¥å‘Š

---

## ğŸ“‹ æ‰§è¡Œæ‘˜è¦

æœ¬æ–‡æ¡£å…¨é¢æ¢³ç†äº† ZakYip.Singulation é¡¹ç›®ä¸­ SignalR å®æ—¶é€šä¿¡ç³»ç»Ÿçš„å®ç°ç°çŠ¶ï¼ŒåŒ…æ‹¬å·²è¦†ç›–çš„åŠŸèƒ½ç‰¹æ€§ã€å·²å®Œæˆçš„ä¼˜åŒ–æªæ–½ï¼Œä»¥åŠæœªæ¥å¯èƒ½çš„æ”¹è¿›æ–¹å‘ã€‚

**å…³é”®å‘ç°**ï¼š
- âœ… SignalR å®ç°å·²ç»éå¸¸å®Œå–„ï¼Œæ¶æ„æ¸…æ™°ï¼Œæ€§èƒ½ä¼˜åŒ–åˆ°ä½
- âœ… å·²å®æ–½çš„ä¼˜åŒ–åŒ…æ‹¬ï¼šå¯¹è±¡æ± åŒ–ã€æ–­è·¯å™¨æ¨¡å¼ã€å¥åº·æ£€æŸ¥ã€é˜Ÿåˆ—ç›‘æ§ç­‰
- âœ… æµ‹è¯•è¦†ç›–ç‡è‰¯å¥½ï¼ŒåŒ…å« 8 ä¸ªé’ˆå¯¹æ€§å•å…ƒæµ‹è¯•
- âš ï¸ éƒ¨åˆ†é«˜çº§ç‰¹æ€§ï¼ˆå¦‚èº«ä»½éªŒè¯ã€é€Ÿç‡é™åˆ¶ï¼‰å°šæœªå®ç°ï¼Œå¯ä½œä¸ºæœªæ¥å¢å¼ºæ–¹å‘

---

## ä¸€ã€SignalR å½“å‰è¦†ç›–å†…å®¹

### 1.1 æ ¸å¿ƒæ¶æ„ç»„ä»¶

#### 1.1.1 æœåŠ¡ç«¯ç»„ä»¶ï¼ˆHost å±‚ï¼‰

| ç»„ä»¶åç§° | æ–‡ä»¶è·¯å¾„ | ä¸»è¦åŠŸèƒ½ | å®ç°çŠ¶æ€ |
|---------|---------|---------|---------|
| **EventsHub** | `Host/SignalR/Hubs/EventsHub.cs` | SignalR Hub æ ¸å¿ƒï¼Œæä¾›é¢‘é“ç»„ç®¡ç†å’Œå¿ƒè·³æ£€æµ‹ | âœ… å®Œæ•´ |
| **SignalRRealtimeNotifier** | `Host/SignalR/SignalRRealtimeNotifier.cs` | å®ç° `IRealtimeNotifier` æ¥å£ï¼Œéé˜»å¡æ¶ˆæ¯å‘å¸ƒ | âœ… å®Œæ•´ |
| **RealtimeDispatchService** | `Host/SignalR/RealtimeDispatchService.cs` | åå°æœåŠ¡ï¼Œè´Ÿè´£æ¶ˆæ¯é˜Ÿåˆ—å¤„ç†å’Œå¹¿æ’­ | âœ… å®Œæ•´ |
| **SignalRHealthCheck** | `Host/SignalR/SignalRHealthCheck.cs` | å¥åº·æ£€æŸ¥ï¼Œç›‘æ§é˜Ÿåˆ—æ·±åº¦å’Œå¤±è´¥ç‡ | âœ… å®Œæ•´ |
| **MessageEnvelope** | `Host/SignalR/MessageEnvelope.cs` | æ¶ˆæ¯å°è£…å¯¹è±¡ï¼Œæ”¯æŒå¯¹è±¡æ± å¤ç”¨ | âœ… å®Œæ•´ |
| **MessageEnvelopePoolPolicy** | `Host/SignalR/MessageEnvelopePoolPolicy.cs` | å¯¹è±¡æ± ç­–ç•¥ï¼Œå‡å°‘ GC å‹åŠ› | âœ… å®Œæ•´ |
| **SignalRQueueItem** | `Host/SignalR/SignalRQueueItem.cs` | é˜Ÿåˆ—é¡¹æ•°æ®ç»“æ„ | âœ… å®Œæ•´ |
| **SignalRSetup** | `Host/Extensions/SignalRSetup.cs` | é…ç½®æ‰©å±•ï¼Œé›†ä¸­ç®¡ç† SignalR è®¾ç½® | âœ… å®Œæ•´ |

#### 1.1.2 å®¢æˆ·ç«¯ç»„ä»¶ï¼ˆMauiApp å±‚ï¼‰

| ç»„ä»¶åç§° | æ–‡ä»¶è·¯å¾„ | ä¸»è¦åŠŸèƒ½ | å®ç°çŠ¶æ€ |
|---------|---------|---------|---------|
| **SignalRClientFactory** | `MauiApp/Services/SignalRClientFactory.cs` | å®¢æˆ·ç«¯è¿æ¥å·¥å‚ï¼Œæ”¯æŒè‡ªåŠ¨é‡è¿å’Œå»¶è¿Ÿç›‘æµ‹ | âœ… å®Œæ•´ |

#### 1.1.3 æŠ½è±¡æ¥å£ï¼ˆCore å±‚ï¼‰

| æ¥å£åç§° | æ–‡ä»¶è·¯å¾„ | ä¸»è¦åŠŸèƒ½ | å®ç°çŠ¶æ€ |
|---------|---------|---------|---------|
| **IRealtimeNotifier** | `Core/Abstractions/Realtime/IRealtimeNotifier.cs` | è·¨å±‚å®æ—¶é€šçŸ¥æŠ½è±¡ | âœ… å®Œæ•´ |

### 1.2 åŠŸèƒ½ç‰¹æ€§è¦†ç›–

#### âœ… å·²å®ç°çš„æ ¸å¿ƒåŠŸèƒ½

1. **å®æ—¶æ¶ˆæ¯æ¨é€**
   - æœåŠ¡ç«¯åˆ°å®¢æˆ·ç«¯çš„å•å‘æ¨é€
   - æ”¯æŒé¢‘é“ç»„è®¢é˜…ï¼ˆJoin/Leaveï¼‰
   - æ¶ˆæ¯è‡ªåŠ¨å°è£…ï¼ˆç‰ˆæœ¬å·ã€ç±»å‹ã€æ—¶é—´æˆ³ã€åºåˆ—å·ç­‰ï¼‰

2. **éé˜»å¡å¼‚æ­¥æ¶æ„**
   - ä½¿ç”¨ `Channel<T>` å®ç°ç”Ÿäº§è€…-æ¶ˆè´¹è€…æ¨¡å¼
   - `TryWrite` ç­–ç•¥ï¼Œé¿å…é˜»å¡ä¸šåŠ¡é€»è¾‘
   - æœ‰ç•Œé€šé“å®¹é‡ï¼š50,000 æ¡æ¶ˆæ¯
   - èƒŒå‹ç­–ç•¥ï¼š`DropOldest`ï¼ˆä¸¢æ—§ä¿æ–°ï¼‰

3. **è‡ªåŠ¨é‡è¿æœºåˆ¶**
   - å®¢æˆ·ç«¯æ”¯æŒè‡ªåŠ¨é‡è¿
   - é‡è¿ç­–ç•¥ï¼š0s, 2s, 10sï¼ˆå¯é…ç½®ä¸ºæ— é™é‡è¿ï¼‰
   - è¿æ¥çŠ¶æ€ç›‘å¬ï¼ˆReconnecting, Reconnected, Closedï¼‰

4. **æ¶ˆæ¯å®Œæ•´æ€§ä¿éšœ**
   - æ¯ä¸ªé¢‘é“ç‹¬ç«‹çš„æ¶ˆæ¯åºåˆ—å·
   - å®¢æˆ·ç«¯å¯æ£€æµ‹æ¶ˆæ¯ä¸¢å¤±
   - TraceId æ”¯æŒï¼Œä¾¿äºåˆ†å¸ƒå¼è¿½è¸ª

5. **å¿ƒè·³ä¸å»¶è¿Ÿç›‘æµ‹**
   - æœåŠ¡ç«¯æä¾› `Ping()` æ–¹æ³•
   - å®¢æˆ·ç«¯æ¯ 5 ç§’æ£€æµ‹ä¸€æ¬¡å»¶è¿Ÿ
   - å®æ—¶æ›´æ–°è¿æ¥å»¶è¿ŸæŒ‡æ ‡

6. **æ€§èƒ½ä¼˜åŒ–**
   - âœ… æ¶ˆæ¯å¯¹è±¡æ± åŒ–ï¼ˆ`MessageEnvelope` + `ObjectPool`ï¼‰
   - âœ… æ–­è·¯å™¨æ¨¡å¼ï¼ˆ5 æ¬¡å¤±è´¥åæ‰“å¼€ï¼Œ30 ç§’åé‡è¯•ï¼‰
   - âœ… é˜Ÿåˆ—æ·±åº¦ç›‘æ§ï¼ˆè¶…è¿‡ 40,000 è­¦å‘Šï¼‰
   - âœ… ç»Ÿè®¡ä¿¡æ¯è·Ÿè¸ªï¼ˆå·²å¤„ç†ã€å¤±è´¥ã€ä¸¢å¼ƒæ¶ˆæ¯æ•°ï¼‰

7. **å¥åº·æ£€æŸ¥**
   - âœ… é›†æˆ ASP.NET Core Health Checks
   - âœ… ç›‘æ§é˜Ÿåˆ—æ·±åº¦ï¼ˆ40,000/50,000 è§¦å‘é™çº§ï¼‰
   - âœ… ç›‘æ§å¤±è´¥ç‡ï¼ˆ>10% è§¦å‘ä¸å¥åº·ï¼‰
   - âœ… æš´éœ²è¯¦ç»†ç»Ÿè®¡æ•°æ®

8. **å¼‚å¸¸å¤„ç†**
   - âœ… ç»†åŒ–å¼‚å¸¸ç±»å‹ï¼ˆHubException, JsonException, OperationCanceledExceptionï¼‰
   - âœ… ä¸åŒå¼‚å¸¸ä½¿ç”¨ä¸åŒæ—¥å¿—çº§åˆ«
   - âœ… å¼‚å¸¸ä¸å½±å“å…¶ä»–æ¶ˆæ¯å¤„ç†

#### âš ï¸ éƒ¨åˆ†å®ç°çš„åŠŸèƒ½

1. **å®¢æˆ·ç«¯é‡è¿ç­–ç•¥**
   - å½“å‰ï¼šä»… 3 æ¬¡é‡è¿å°è¯•ï¼ˆ0s, 2s, 10sï¼‰
   - å»ºè®®ï¼šå®ç°æ— é™é‡è¿ï¼ˆå·²æœ‰æ–‡æ¡£ `SIGNALR_CLIENT_RETRY_POLICY.md`ï¼‰

#### âŒ æœªå®ç°çš„åŠŸèƒ½

1. **èº«ä»½éªŒè¯ä¸æˆæƒ**
   - ç¼ºå°‘ JWT æˆ– API Key è®¤è¯
   - ç¼ºå°‘é¢‘é“çº§åˆ«æƒé™æ§åˆ¶
   - ä»»ä½•äººéƒ½å¯ä»¥è¿æ¥å’Œè®¢é˜…é¢‘é“

2. **é€Ÿç‡é™åˆ¶**
   - å®¢æˆ·ç«¯å¯ä»¥æ— é™é¢‘ç‡è°ƒç”¨ Hub æ–¹æ³•
   - æ½œåœ¨çš„ DoS é£é™©

3. **æ¶ˆæ¯å¤§å°é™åˆ¶**
   - å½“å‰ï¼š`MaximumReceiveMessageSize: null`ï¼ˆæ— é™åˆ¶ï¼‰
   - é£é™©ï¼šè¶…å¤§æ¶ˆæ¯å¯èƒ½å¯¼è‡´å†…å­˜æº¢å‡º

4. **æ¶ˆæ¯å‹ç¼©**
   - æœªå¯ç”¨ MessagePack æˆ– Response Compression
   - é«˜é¢‘åœºæ™¯ä¸‹å¸¦å®½æ¶ˆè€—è¾ƒå¤§

5. **æ¶ˆæ¯æŒä¹…åŒ–**
   - å®¢æˆ·ç«¯ç¦»çº¿æœŸé—´æ¶ˆæ¯ä¸¢å¤±
   - æ— æ¶ˆæ¯å†å²è®°å½•åŠŸèƒ½

6. **åŒå‘é€šä¿¡**
   - ä»…æ”¯æŒæœåŠ¡ç«¯åˆ°å®¢æˆ·ç«¯å•å‘æ¨é€
   - å®¢æˆ·ç«¯æ— æ³•é€šè¿‡ SignalR å‘é€å‘½ä»¤

7. **è¯¦ç»†æ€§èƒ½æŒ‡æ ‡**
   - ç¼ºå°‘æ¶ˆæ¯å‘é€é€Ÿç‡ç›‘æ§
   - ç¼ºå°‘æ¶ˆæ¯å»¶è¿Ÿåˆ†å¸ƒç»Ÿè®¡
   - ç¼ºå°‘æ´»è·ƒè¿æ¥æ•°ç›‘æ§

### 1.3 å®é™…åº”ç”¨åœºæ™¯

SignalR åœ¨ä»¥ä¸‹ä¸šåŠ¡æ¨¡å—ä¸­è¢«å¹¿æ³›ä½¿ç”¨ï¼š

| æ¨¡å—åç§° | ä½¿ç”¨æ–¹å¼ | å‘é€é¢‘ç‡ | é¢‘é“ |
|---------|---------|---------|------|
| **IoStatusWorker** | å®šæœŸå¹¿æ’­ IO çŠ¶æ€ | ~100ms | `/sys` |
| **LogEventPump** | èšåˆå¹¶å¹¿æ’­æ—¥å¿—äº‹ä»¶ | ~100ms | `/sys` |
| **TransportEventPump** | å¹¿æ’­è§†è§‰å’Œè®¾å¤‡äº‹ä»¶ | å®æ—¶ | `/vision`, `/device` |
| **SpeedFrameWorker** | å¹¿æ’­é€Ÿåº¦å˜åŒ– | å®æ—¶ | `/sys` |
| **SafetyPipeline** | å¹¿æ’­å®‰å…¨äº‹ä»¶ | å®æ—¶ | `/errors` |
| **SafetyIsolator** | å¹¿æ’­éš”ç¦»äº‹ä»¶ | å®æ—¶ | `/errors` |

---

## äºŒã€å·²å®Œæˆçš„ä¼˜åŒ–æªæ–½

### 2.1 æ€§èƒ½ä¼˜åŒ–

#### âœ… 1. æ¶ˆæ¯å¯¹è±¡æ± åŒ–ï¼ˆå·²å®Œæˆï¼‰

**é—®é¢˜**ï¼šæ¯æ¡æ¶ˆæ¯åˆ›å»ºåŒ¿åå¯¹è±¡ï¼Œé«˜é¢‘åœºæ™¯ä¸‹ GC å‹åŠ›å¤§

**è§£å†³æ–¹æ¡ˆ**ï¼š
- ä½¿ç”¨ `Microsoft.Extensions.ObjectPool`
- åˆ›å»º `MessageEnvelope` ç±»å’Œ `MessageEnvelopePoolPolicy`
- å¯¹è±¡è·å–ã€ä½¿ç”¨ã€å½’è¿˜æµç¨‹å®Œå–„

**ä»£ç ç¤ºä¾‹**ï¼š
```csharp
var envelope = _envelopePool.Get();
try {
    envelope.Type = item.Payload.GetType().Name;
    // ... è®¾ç½®å…¶ä»–å±æ€§
    await _hub.Clients.Group(item.Channel).SendAsync("event", envelope, stoppingToken);
}
finally {
    _envelopePool.Return(envelope);
}
```

**æ”¶ç›Š**ï¼šå‡å°‘å¯¹è±¡åˆ†é…ï¼Œé™ä½ GC å‹åŠ›

#### âœ… 2. Channel å®¹é‡ä¼˜åŒ–ï¼ˆå·²å®Œæˆï¼‰

**å˜æ›´**ï¼šä» 10,000 å¢åŠ åˆ° 50,000

**ç†ç”±**ï¼š
- æ”¯æŒæ›´é«˜çš„å¹¶å‘æ¶ˆæ¯é‡
- å‡å°‘æ¶ˆæ¯ä¸¢å¤±é£é™©
- åº”å¯¹ç½‘ç»œæŠ–åŠ¨å’Œå®¢æˆ·ç«¯å“åº”å»¶è¿Ÿ

#### âœ… 3. é˜Ÿåˆ—æ·±åº¦ç›‘æ§ï¼ˆå·²å®Œæˆï¼‰

**å®ç°**ï¼š
- `MonitorQueueDepthAsync` æ–¹æ³•æ¯ 10 ç§’æ£€æŸ¥ä¸€æ¬¡
- è¶…è¿‡ 40,000 æ—¶è®°å½•è­¦å‘Šæ—¥å¿—
- åŒ…å«å·²å¤„ç†ã€å¤±è´¥ã€ä¸¢å¼ƒæ¶ˆæ¯æ•°ç»Ÿè®¡

**ä»£ç ç¤ºä¾‹**ï¼š
```csharp
var count = _chan.Reader.Count;
if (count > 40000) {
    _logger.LogWarning(
        "SignalR queue depth high: {Count}/50000, Processed: {Processed}, Failed: {Failed}, Dropped: {Dropped}",
        count, _messagesProcessed, _messagesFailed, _messagesDropped);
}
```

#### âœ… 4. æ–­è·¯å™¨æ¨¡å¼ï¼ˆå·²å®Œæˆï¼‰

**å®ç°**ï¼š
- æ¯ä¸ªé¢‘é“ç‹¬ç«‹çš„æ–­è·¯å™¨çŠ¶æ€
- 5 æ¬¡è¿ç»­å¤±è´¥åæ‰“å¼€æ–­è·¯å™¨
- æ‰“å¼€æœŸé—´è·³è¿‡æ¶ˆæ¯å‘é€ï¼Œé¿å…æŒç»­å¤±è´¥
- 30 ç§’åå°è¯•é‡ç½®

**ä»£ç ç¤ºä¾‹**ï¼š
```csharp
private sealed class CircuitBreakerState {
    private const int FailureThreshold = 5;
    private const int TimeoutSeconds = 30;
    
    public bool IsOpen => _failureCount >= FailureThreshold && 
                          (DateTime.UtcNow - _openedTime).TotalSeconds < TimeoutSeconds;
}
```

**æ”¶ç›Š**ï¼šä¿æŠ¤ç³»ç»Ÿèµ„æºï¼Œé¿å…é›ªå´©æ•ˆåº”

### 2.2 å¯é æ€§ä¼˜åŒ–

#### âœ… 5. å¥åº·æ£€æŸ¥é›†æˆï¼ˆå·²å®Œæˆï¼‰

**å®ç°**ï¼š
- `SignalRHealthCheck` å®ç° `IHealthCheck`
- ç›‘æ§é˜Ÿåˆ—æ·±åº¦
- ç›‘æ§æ¶ˆæ¯å¤±è´¥ç‡
- æš´éœ²è¯¦ç»†ç»Ÿè®¡æ•°æ®

**å¥åº·çŠ¶æ€åˆ¤æ–­**ï¼š
- **Healthy**: é˜Ÿåˆ—æ·±åº¦ < 40,000 ä¸”å¤±è´¥ç‡ < 10%
- **Degraded**: é˜Ÿåˆ—æ·±åº¦ > 40,000
- **Unhealthy**: å¤±è´¥ç‡ > 10%

**é›†æˆæ–¹å¼**ï¼š
```csharp
services.AddHealthChecks()
    .AddCheck<SignalRHealthCheck>("signalr", tags: new[] { "realtime", "signalr" });
```

#### âœ… 6. å¼‚å¸¸å¤„ç†ç»†åŒ–ï¼ˆå·²å®Œæˆï¼‰

**æ”¹è¿›å‰**ï¼šä½¿ç”¨é€šç”¨ `catch (Exception ex)`

**æ”¹è¿›å**ï¼š
```csharp
catch (HubException hex) {
    _logger.LogError(hex, "Hub error broadcasting to {Channel}", item.Channel);
}
catch (JsonException jex) {
    _logger.LogError(jex, "Serialization error for {Channel}, Type: {Type}", ...);
}
catch (OperationCanceledException) when (stoppingToken.IsCancellationRequested) {
    break; // æ­£å¸¸å…³é—­
}
catch (Exception ex) {
    _logger.LogWarning(ex, "Unexpected error broadcasting to {Channel}", ...);
}
```

**æ”¶ç›Š**ï¼šæ›´å¥½çš„é”™è¯¯è¯Šæ–­å’Œæ—¥å¿—è®°å½•

#### âœ… 7. Ping æ–¹æ³•å®ç°ï¼ˆå·²å®Œæˆï¼‰

**é—®é¢˜**ï¼šå®¢æˆ·ç«¯è°ƒç”¨ `InvokeAsync("Ping")` ä½†æœåŠ¡ç«¯æœªå®ç°

**è§£å†³æ–¹æ¡ˆ**ï¼š
```csharp
public Task Ping() => Task.CompletedTask;
```

**æ”¶ç›Š**ï¼šä¿®å¤å®¢æˆ·ç«¯å»¶è¿Ÿç›‘æµ‹åŠŸèƒ½

### 2.3 é…ç½®ä¼˜åŒ–

#### âœ… 8. SignalR é…ç½®å‚æ•°è°ƒä¼˜ï¼ˆå·²å®Œæˆï¼‰

```csharp
services.AddSignalR(opt => {
    opt.HandshakeTimeout = TimeSpan.FromMinutes(1);
    opt.EnableDetailedErrors = true;  // å¼€å‘ç¯å¢ƒä¾¿äºè°ƒè¯•
    opt.MaximumReceiveMessageSize = null;  // âš ï¸ å»ºè®®è®¾ç½®é™åˆ¶
    opt.KeepAliveInterval = TimeSpan.FromMinutes(1);
    opt.ClientTimeoutInterval = TimeSpan.FromMinutes(5);
    opt.MaximumParallelInvocationsPerClient = 10;
    opt.StreamBufferCapacity = int.MaxValue;
})
.AddNewtonsoftJsonProtocol();  // ä¸å…¨å±€ JSON é…ç½®ä¸€è‡´
```

---

## ä¸‰ã€æµ‹è¯•è¦†ç›–æƒ…å†µ

### 3.1 å•å…ƒæµ‹è¯•åˆ—è¡¨

| æµ‹è¯•åç§° | æµ‹è¯•å†…å®¹ | çŠ¶æ€ |
|---------|---------|------|
| `MessageEnvelope_Reset_ClearsAllFields` | éªŒè¯æ¶ˆæ¯å°è£…å¯¹è±¡é‡ç½®åŠŸèƒ½ | âœ… é€šè¿‡ |
| `MessageEnvelopePoolPolicy_Create_ReturnsNewInstance` | éªŒè¯å¯¹è±¡æ± åˆ›å»ºé€»è¾‘ | âœ… é€šè¿‡ |
| `MessageEnvelopePoolPolicy_Return_ResetsObject` | éªŒè¯å¯¹è±¡æ± å½’è¿˜é€»è¾‘ | âœ… é€šè¿‡ |
| `SignalRQueueItem_Constructor_SetsProperties` | éªŒè¯é˜Ÿåˆ—é¡¹æ„é€  | âœ… é€šè¿‡ |
| `EventsHub_Ping_ReturnsCompletedTask` | éªŒè¯ Ping æ–¹æ³• | âœ… é€šè¿‡ |
| `RealtimeDispatchService_GetStatistics_ReturnsInitialValues` | éªŒè¯ç»Ÿè®¡åˆå§‹å€¼ | âœ… é€šè¿‡ |
| `SignalRHealthCheck_CheckHealthAsync_ReturnsHealthyWhenQueueLow` | éªŒè¯å¥åº·æ£€æŸ¥ï¼ˆæ­£å¸¸ï¼‰ | âœ… é€šè¿‡ |
| `SignalRHealthCheck_CheckHealthAsync_ReturnsDegradedWhenQueueHigh` | éªŒè¯å¥åº·æ£€æŸ¥ï¼ˆé™çº§ï¼‰ | âœ… é€šè¿‡ |

**æµ‹è¯•æ–‡ä»¶**ï¼š`ZakYip.Singulation.Tests/SignalRTests.cs`

### 3.2 æµ‹è¯•è¦†ç›–ç‡åˆ†æ

- âœ… æ ¸å¿ƒç»„ä»¶å•å…ƒæµ‹è¯•å®Œæ•´
- âœ… å¯¹è±¡æ± é€»è¾‘æµ‹è¯•å……åˆ†
- âœ… å¥åº·æ£€æŸ¥è¾¹ç•Œæ¡ä»¶æµ‹è¯•å®Œå–„
- âš ï¸ ç¼ºå°‘é›†æˆæµ‹è¯•ï¼ˆç«¯åˆ°ç«¯æ¶ˆæ¯ä¼ é€’ï¼‰
- âš ï¸ ç¼ºå°‘è´Ÿè½½æµ‹è¯•ï¼ˆé«˜å¹¶å‘åœºæ™¯ï¼‰
- âš ï¸ ç¼ºå°‘æ€§èƒ½æµ‹è¯•ï¼ˆååé‡å’Œå»¶è¿Ÿï¼‰

---

## å››ã€æ¶æ„ä¼˜åŠ¿æ€»ç»“

### 4.1 è®¾è®¡æ¨¡å¼

| æ¨¡å¼åç§° | åº”ç”¨åœºæ™¯ | ä¼˜åŠ¿ |
|---------|---------|------|
| **ç”Ÿäº§è€…-æ¶ˆè´¹è€…æ¨¡å¼** | `Channel<SignalRQueueItem>` | è§£è€¦ä¸šåŠ¡é€»è¾‘å’Œæ¶ˆæ¯æ¨é€ |
| **å¯¹è±¡æ± æ¨¡å¼** | `MessageEnvelope` å¤ç”¨ | å‡å°‘ GC å‹åŠ› |
| **æ–­è·¯å™¨æ¨¡å¼** | é¢‘é“çº§åˆ«å¤±è´¥ä¿æŠ¤ | é¿å…æŒç»­å¤±è´¥ |
| **å·¥å‚æ¨¡å¼** | `SignalRClientFactory` | ç»Ÿä¸€å®¢æˆ·ç«¯åˆ›å»º |
| **æŠ½è±¡æ¥å£æ¨¡å¼** | `IRealtimeNotifier` | æé«˜å¯æµ‹è¯•æ€§ |

### 4.2 æ ¸å¿ƒä¼˜åŠ¿

1. **åˆ†å±‚æ¸…æ™°**
   - Core å±‚ï¼šæŠ½è±¡æ¥å£
   - Host å±‚ï¼šæœåŠ¡ç«¯å®ç°
   - MauiApp å±‚ï¼šå®¢æˆ·ç«¯å®ç°
   - å„å±‚èŒè´£æ˜ç¡®ï¼Œä½è€¦åˆ

2. **éé˜»å¡è®¾è®¡**
   - `TryWrite` é¿å…é˜»å¡ä¸šåŠ¡é€»è¾‘
   - åå°æœåŠ¡å¼‚æ­¥å¤„ç†æ¶ˆæ¯
   - ä¸šåŠ¡å±‚æ€§èƒ½ä¸å— SignalR å½±å“

3. **èƒŒå‹å¤„ç†**
   - æœ‰ç•Œé€šé“é˜²æ­¢å†…å­˜æº¢å‡º
   - `DropOldest` ç­–ç•¥ä¿è¯æ–°æ¶ˆæ¯ä¼˜å…ˆ
   - é˜Ÿåˆ—æ·±åº¦ç›‘æ§åŠæ—¶é¢„è­¦

4. **å¯æµ‹è¯•æ€§**
   - æ¥å£æŠ½è±¡ä¾¿äºå•å…ƒæµ‹è¯•
   - æä¾› `ConsoleRealtimeNotifier` ç”¨äºæµ‹è¯•
   - Mock å®ç°ç®€å•

5. **å¯è§‚æµ‹æ€§**
   - å¥åº·æ£€æŸ¥é›†æˆ
   - è¯¦ç»†æ—¥å¿—è®°å½•
   - ç»Ÿè®¡ä¿¡æ¯æš´éœ²

---

## äº”ã€æœªæ¥ä¼˜åŒ–æ–¹å‘

### 5.1 é«˜ä¼˜å…ˆçº§ï¼ˆå»ºè®®å®æ–½ï¼‰

#### 1. æ·»åŠ èº«ä»½éªŒè¯ä¸æˆæƒ

**ç›®æ ‡**ï¼šé˜²æ­¢æœªæˆæƒè®¿é—®

**æ–¹æ¡ˆ**ï¼š
- æ·»åŠ  JWT è®¤è¯
- å®ç°é¢‘é“çº§åˆ«æƒé™æ§åˆ¶
- åœ¨ `Join/Leave` æ–¹æ³•ä¸­éªŒè¯æƒé™

**å‚è€ƒå®ç°**ï¼š
```csharp
[Authorize]
public sealed class EventsHub : Hub {
    public Task Join(string channel) {
        if (!IsAuthorizedForChannel(channel)) {
            throw new HubException("Unauthorized access to channel");
        }
        return Groups.AddToGroupAsync(Context.ConnectionId, channel);
    }
}
```

#### 2. è®¾ç½®æ¶ˆæ¯å¤§å°é™åˆ¶

**ç›®æ ‡**ï¼šé˜²æ­¢ DoS æ”»å‡»å’Œå†…å­˜æº¢å‡º

**æ–¹æ¡ˆ**ï¼š
```csharp
opt.MaximumReceiveMessageSize = 1024 * 1024; // 1MB
```

#### 3. æ·»åŠ é€Ÿç‡é™åˆ¶

**ç›®æ ‡**ï¼šé˜²æ­¢å®¢æˆ·ç«¯æ»¥ç”¨

**æ–¹æ¡ˆ**ï¼š
- ä½¿ç”¨ ASP.NET Core Rate Limiting ä¸­é—´ä»¶
- é™åˆ¶æ¯ä¸ªå®¢æˆ·ç«¯çš„è°ƒç”¨é¢‘ç‡

### 5.2 ä¸­ä¼˜å…ˆçº§ï¼ˆå¯é€‰å®æ–½ï¼‰

#### 4. æ”¹è¿›å®¢æˆ·ç«¯é‡è¿ç­–ç•¥

**ç›®æ ‡**ï¼šæ— é™é‡è¿ï¼Œæé«˜å¯ç”¨æ€§

**æ–¹æ¡ˆ**ï¼šå®ç°è‡ªå®šä¹‰ `IRetryPolicy`ï¼ˆå·²æœ‰æ–‡æ¡£ `SIGNALR_CLIENT_RETRY_POLICY.md`ï¼‰

#### 5. æ·»åŠ è¯¦ç»†æ€§èƒ½æŒ‡æ ‡

**ç›®æ ‡**ï¼šå…¨é¢ç›‘æ§ç³»ç»Ÿæ€§èƒ½

**æ–¹æ¡ˆ**ï¼šä½¿ç”¨ `System.Diagnostics.Metrics`
- æ¶ˆæ¯å‘é€é€Ÿç‡ï¼ˆæ¯ç§’æ¶ˆæ¯æ•°ï¼‰
- æ¶ˆæ¯å»¶è¿Ÿåˆ†å¸ƒ
- æ´»è·ƒè¿æ¥æ•°
- æ¯ä¸ªé¢‘é“è®¢é˜…è€…æ•°é‡

#### 6. å¯ç”¨æ¶ˆæ¯å‹ç¼©

**ç›®æ ‡**ï¼šå‡å°‘å¸¦å®½æ¶ˆè€—

**æ–¹æ¡ˆ**ï¼š
- é€‰é¡¹ 1ï¼šä½¿ç”¨ MessagePack åè®®ï¼ˆæ›´é«˜æ•ˆï¼‰
- é€‰é¡¹ 2ï¼šå¯ç”¨ Response Compressionï¼ˆBrotli/Gzipï¼‰

### 5.3 ä½ä¼˜å…ˆçº§ï¼ˆæœªæ¥å¢å¼ºï¼‰

#### 7. æ¶ˆæ¯æŒä¹…åŒ–

**ç›®æ ‡**ï¼šæ”¯æŒç¦»çº¿æ¶ˆæ¯é‡æ”¾

**æ–¹æ¡ˆ**ï¼š
- é›†æˆ Redis æˆ–æ•°æ®åº“
- å®¢æˆ·ç«¯é‡è¿åè·å–ç¦»çº¿æ¶ˆæ¯
- æ·»åŠ æ¶ˆæ¯ TTL æœºåˆ¶

#### 8. åŒå‘é€šä¿¡

**ç›®æ ‡**ï¼šæ”¯æŒå®¢æˆ·ç«¯åˆ°æœåŠ¡ç«¯æ¶ˆæ¯

**æ–¹æ¡ˆ**ï¼š
- æ·»åŠ æœåŠ¡ç«¯æ¥æ”¶æ–¹æ³•
- å®ç°è¯·æ±‚-å“åº”æ¨¡å¼

---

## å…­ã€æ€§èƒ½æŒ‡æ ‡å‚è€ƒ

### 6.1 å½“å‰é…ç½®

| å‚æ•° | é…ç½®å€¼ | è¯´æ˜ |
|------|--------|------|
| **Channel å®¹é‡** | 50,000 | æœ€å¤§ç¼“å­˜æ¶ˆæ¯æ•° |
| **èƒŒå‹ç­–ç•¥** | DropOldest | é˜Ÿåˆ—æ»¡æ—¶ä¸¢å¼ƒæœ€æ—§æ¶ˆæ¯ |
| **å¿ƒè·³é—´éš”** | 1 åˆ†é’Ÿ | KeepAliveInterval |
| **å®¢æˆ·ç«¯è¶…æ—¶** | 5 åˆ†é’Ÿ | ClientTimeoutInterval |
| **æ¡æ‰‹è¶…æ—¶** | 1 åˆ†é’Ÿ | HandshakeTimeout |
| **å¹¶å‘è°ƒç”¨é™åˆ¶** | 10 | MaximumParallelInvocationsPerClient |

### 6.2 é¢„æœŸæ€§èƒ½

åŸºäºå½“å‰é…ç½®ï¼Œé¢„æœŸæ€§èƒ½æŒ‡æ ‡ï¼š

| æŒ‡æ ‡ | ä¼°ç®—å€¼ | å¤‡æ³¨ |
|------|--------|------|
| **ååé‡** | > 10,000 msg/s | å–å†³äºæ¶ˆæ¯å¤§å°å’Œç½‘ç»œ |
| **å»¶è¿Ÿ** | < 50ms | æœ¬åœ°ç½‘ç»œç¯å¢ƒ |
| **æœ€å¤§è¿æ¥æ•°** | > 1,000 | å–å†³äºæœåŠ¡å™¨èµ„æº |
| **æ¶ˆæ¯ä¸¢å¤±ç‡** | < 0.1% | æ­£å¸¸è´Ÿè½½ä¸‹ |

**æ³¨æ„**ï¼šä»¥ä¸Šä¸ºç†è®ºä¼°ç®—ï¼Œå®é™…æ€§èƒ½éœ€é€šè¿‡è´Ÿè½½æµ‹è¯•éªŒè¯ã€‚

---

## ä¸ƒã€ç›¸å…³æ–‡æ¡£ç´¢å¼•

| æ–‡æ¡£åç§° | æè¿° | è·¯å¾„ |
|---------|------|------|
| **SIGNALR_IMPLEMENTATION_ANALYSIS.md** | è¯¦ç»†å®ç°åˆ†æå’Œä¼˜åŒ–å»ºè®®ï¼ˆè‹±æ–‡ï¼‰ | æ ¹ç›®å½• |
| **SIGNALR_OPTIMIZATION_SUMMARY.md** | ä¼˜åŒ–å®æ–½æ€»ç»“ï¼ˆè‹±æ–‡ï¼‰ | æ ¹ç›®å½• |
| **SIGNALRä¼˜åŒ–å»ºè®®æ‘˜è¦.md** | ä¼˜åŒ–å»ºè®®å¿«é€Ÿå‚è€ƒï¼ˆä¸­æ–‡ï¼‰ | æ ¹ç›®å½• |
| **SIGNALR_CLIENT_RETRY_POLICY.md** | å®¢æˆ·ç«¯é‡è¿ç­–ç•¥å®ç°æŒ‡å— | æ ¹ç›®å½• |

---

## å…«ã€æ€»ç»“ä¸å»ºè®®

### 8.1 ç°çŠ¶æ€»ç»“

ZakYip.Singulation é¡¹ç›®çš„ SignalR å®ç°**éå¸¸å‡ºè‰²**ï¼Œå…·å¤‡ä»¥ä¸‹ç‰¹ç‚¹ï¼š

âœ… **æ¶æ„è®¾è®¡ä¼˜ç§€**
- æ¸…æ™°çš„åˆ†å±‚æ¶æ„
- åˆç†çš„è®¾è®¡æ¨¡å¼åº”ç”¨
- é«˜å†…èšä½è€¦åˆ

âœ… **æ€§èƒ½ä¼˜åŒ–åˆ°ä½**
- å¯¹è±¡æ± åŒ–å‡å°‘ GC å‹åŠ›
- æ–­è·¯å™¨æ¨¡å¼ä¿æŠ¤ç³»ç»Ÿ
- é˜Ÿåˆ—æ·±åº¦ç›‘æ§åŠæ—¶é¢„è­¦

âœ… **å¯é æ€§ä¿éšœ**
- å¥åº·æ£€æŸ¥é›†æˆ
- ç»†åŒ–çš„å¼‚å¸¸å¤„ç†
- å®Œå–„çš„æµ‹è¯•è¦†ç›–

âœ… **å¯ç»´æŠ¤æ€§é«˜**
- ä»£ç ç»“æ„æ¸…æ™°
- æ–‡æ¡£è¯¦å°½å®Œæ•´
- æµ‹è¯•ç”¨ä¾‹å……åˆ†

### 8.2 æ”¹è¿›å»ºè®®

è™½ç„¶ç°æœ‰å®ç°å·²ç»å¾ˆå®Œå–„ï¼Œä½†ä»æœ‰æ”¹è¿›ç©ºé—´ï¼š

**é«˜ä¼˜å…ˆçº§**ï¼ˆå®‰å…¨æ€§ç›¸å…³ï¼‰ï¼š
1. æ·»åŠ èº«ä»½éªŒè¯å’Œæˆæƒæœºåˆ¶
2. è®¾ç½®æ¶ˆæ¯å¤§å°é™åˆ¶ï¼ˆé˜²æ­¢ DoSï¼‰
3. æ·»åŠ é€Ÿç‡é™åˆ¶ï¼ˆé˜²æ­¢æ»¥ç”¨ï¼‰

**ä¸­ä¼˜å…ˆçº§**ï¼ˆå¯è§‚æµ‹æ€§å’Œæ€§èƒ½ï¼‰ï¼š
1. æ”¹è¿›å®¢æˆ·ç«¯é‡è¿ç­–ç•¥ï¼ˆæ— é™é‡è¿ï¼‰
2. æ·»åŠ è¯¦ç»†æ€§èƒ½æŒ‡æ ‡ï¼ˆMetricsï¼‰
3. å¯ç”¨æ¶ˆæ¯å‹ç¼©ï¼ˆå‡å°‘å¸¦å®½ï¼‰

**ä½ä¼˜å…ˆçº§**ï¼ˆåŠŸèƒ½å¢å¼ºï¼‰ï¼š
1. æ¶ˆæ¯æŒä¹…åŒ–ï¼ˆç¦»çº¿æ¶ˆæ¯ï¼‰
2. åŒå‘é€šä¿¡ï¼ˆå®¢æˆ·ç«¯åˆ°æœåŠ¡ç«¯ï¼‰

### 8.3 å®æ–½è·¯çº¿å›¾

**é˜¶æ®µ 1ï¼šå®‰å…¨åŠ å›ºï¼ˆ1-2 å‘¨ï¼‰**
- å®ç° JWT è®¤è¯
- æ·»åŠ æ¶ˆæ¯å¤§å°å’Œé€Ÿç‡é™åˆ¶
- å®‰å…¨å®¡è®¡å’Œæµ‹è¯•

**é˜¶æ®µ 2ï¼šå¯è§‚æµ‹æ€§å¢å¼ºï¼ˆ1 å‘¨ï¼‰**
- é›†æˆ Metrics ç›‘æ§
- æ”¹è¿›æ—¥å¿—è®°å½•
- æ·»åŠ ç›‘æ§ä»ªè¡¨ç›˜

**é˜¶æ®µ 3ï¼šæ€§èƒ½ä¼˜åŒ–ï¼ˆ1 å‘¨ï¼‰**
- å¯ç”¨æ¶ˆæ¯å‹ç¼©
- æ€§èƒ½æµ‹è¯•å’Œè°ƒä¼˜
- è´Ÿè½½æµ‹è¯•éªŒè¯

**é˜¶æ®µ 4ï¼šåŠŸèƒ½å¢å¼ºï¼ˆå¯é€‰ï¼‰**
- æ ¹æ®ä¸šåŠ¡éœ€æ±‚å†³å®šæ˜¯å¦å®æ–½
- æ¶ˆæ¯æŒä¹…åŒ–å’ŒåŒå‘é€šä¿¡

---

**æ–‡æ¡£ç»´æŠ¤è€…**: GitHub Copilot Agent  
**æœ€åæ›´æ–°**: 2025-10-30  
**ç‰ˆæœ¬**: 1.0  
**çŠ¶æ€**: âœ… å·²å®Œæˆ
