# API 操作说明

本文档详细说明调用各个 API 后会触发的操作和系统响应。

## 目录

- [轴控制 API](#轴控制-api)
- [安全控制 API](#安全控制-api)
- [上游通信 API](#上游通信-api)
- [解码器 API](#解码器-api)
- [IO 监控 API](#io-监控-api)
- [IO 状态 API](#io-状态-api)
- [系统会话 API](#系统会话-api)

---

## 轴控制 API

基础路径：`/api/axes`

### 1. 获取控制器配置
**GET** `/api/axes/controller/options`

**触发操作**：
- 从 LiteDB 数据库读取控制器配置（厂商类型和驱动选项）
- 返回当前的 Vendor（厂商）和 Template（驱动参数模板）

**系统影响**：无副作用，仅读取操作

---

### 2. 更新控制器配置
**PUT** `/api/axes/controller/options`

**触发操作**：
- 验证请求参数（Vendor 必填）
- 将新的控制器配置持久化到 LiteDB
- 更新系统内存中的控制器配置

**系统影响**：
- 配置立即生效，影响后续的轴初始化
- 不影响已初始化的轴实例

---

### 3. 获取轴网格布局
**GET** `/api/axes/topology`

**触发操作**：
- 从 LiteDB 读取轴网格布局配置（行数、列数、轴位置映射）
- 返回当前的物理布局排列方式

**系统影响**：无副作用，仅读取操作

---

### 4. 更新轴网格布局
**PUT** `/api/axes/topology`

**触发操作**：
- 验证布局参数（行数和列数必须 >= 1）
- 全量覆盖当前的轴网格布局配置
- 持久化到 LiteDB

**系统影响**：
- 布局配置立即生效
- 影响上游速度帧的解码和映射逻辑
- 已运行的轴不受影响，但后续接收的速度帧会按新布局解码

---

### 5. 删除轴网格布局
**DELETE** `/api/axes/topology`

**触发操作**：
- 从 LiteDB 删除轴网格布局配置
- 系统恢复到默认布局

**系统影响**：
- 清除自定义布局，恢复默认行为
- 后续速度帧解码将使用默认布局

---

### 6. 查询控制器状态
**GET** `/api/axes/controller`

**触发操作**：
- 查询底层驱动总线状态
- 读取所有已注册轴的基本信息
- 返回控制器总数、轴总数、错误代码等

**系统影响**：无副作用，仅读取操作

---

### 7. 控制器复位
**POST** `/api/axes/controller/reset`

**触发操作**：
1. 停止所有运动轴
2. 调用底层驱动的复位命令
3. 清除错误状态
4. 重新初始化控制器

**系统影响**：
- **所有轴立即停止运动**
- 清除所有错误和告警
- 系统状态复位到初始状态
- 可能导致短暂的通信中断（100-500ms）

---

### 8. 查询控制器错误
**GET** `/api/axes/controller/errors`

**触发操作**：
- 读取所有控制器和轴的错误代码
- 从底层驱动查询错误状态

**系统影响**：无副作用，仅读取操作

---

### 9. 清除控制器错误
**DELETE** `/api/axes/controller/errors`

**触发操作**：
- 调用底层驱动的错误清除命令
- 重置错误标志位
- 记录清除操作到日志

**系统影响**：
- 清除硬件错误状态
- 允许轴恢复运动（如果错误已解决）
- 不会自动重启停止的轴

---

### 10. 查询所有轴状态
**GET** `/api/axes/axes`

**触发操作**：
- 遍历所有已注册轴
- 读取每个轴的实时状态：
  - 使能状态
  - 当前速度（目标速度和反馈速度）
  - 位置信息
  - 错误状态
- 返回轴状态列表

**系统影响**：无副作用，仅读取操作

---

### 11. 查询单个轴状态
**GET** `/api/axes/axes/{axisId}`

**触发操作**：
- 验证轴 ID 是否存在
- 读取指定轴的详细状态
- 返回轴的所有属性和实时数据

**系统影响**：无副作用，仅读取操作

---

### 12. 批量更新轴参数
**PATCH** `/api/axes/axes`

**触发操作**：
1. 验证请求中的轴 ID 列表
2. 对每个轴应用参数更新（使能状态、速度等）
3. 将更新写入底层驱动
4. 广播轴状态变化事件到 SignalR

**系统影响**：
- 立即更新指定轴的参数
- 触发 SignalR 实时推送
- 不影响其他未指定的轴

---

### 13. 更新单个轴参数
**PATCH** `/api/axes/axes/{axisId}`

**触发操作**：
1. 验证轴 ID 是否存在
2. 应用参数更新到指定轴
3. 将更新写入底层驱动
4. 广播轴状态变化事件

**系统影响**：
- 立即更新指定轴的参数
- 触发 SignalR 实时推送

---

### 14. 批量使能轴
**POST** `/api/axes/axes/enable`

**触发操作**：
1. 验证轴 ID 列表
2. 对每个轴调用使能命令
3. 激活电机驱动器
4. 轴准备好接收运动指令

**系统影响**：
- **启用电机伺服控制**
- 轴可以开始运动
- 消耗电机功率
- 可能产生轻微噪音（伺服锁定）

---

### 15. 批量禁用轴
**POST** `/api/axes/axes/disable`

**触发操作**：
1. 验证轴 ID 列表
2. 对每个轴调用禁用命令
3. 释放电机驱动器
4. 轴停止响应运动指令

**系统影响**：
- **立即切断电机伺服控制**
- 轴自由停止（可能有惯性滑行）
- 释放电机功率
- 电机进入自由状态（可手动推动）

---

### 16. 批量设置速度
**POST** `/api/axes/axes/speed`

**触发操作**：
1. 验证轴 ID 列表和速度值
2. 对每个轴应用速度设定
3. 速度经过规划器处理（平滑、限幅）
4. 下发脉冲频率到电机驱动器
5. 广播速度变化事件

**系统影响**：
- **轴立即按新速度运动**
- 触发 SignalR 实时推送速度变化
- 记录速度变化到日志
- 如果速度超出限制，将被自动钳制

---

## 安全控制 API

基础路径：`/api/safety`

### 1. 执行安全命令
**POST** `/api/safety/commands`

**请求参数**：
```json
{
  "Command": 1,  // 1=启动, 2=停止, 3=复位, 4=急停
  "Reason": "操作原因说明"
}
```

**触发操作**：

#### 启动命令 (Command = 1)
1. 检查系统是否处于可启动状态
2. 验证所有安全条件
3. 激活安全管线
4. 允许速度帧应用
5. 记录启动事件到审计日志

**系统影响**：
- 系统进入运行模式
- 允许接收和执行速度指令
- 触发 SignalR 推送启动事件
- 所有安全检查启用

#### 停止命令 (Command = 2)
1. 触发安全停止流程
2. 所有轴速度设为 0
3. 进入降级模式
4. 拒绝新的速度指令
5. 记录停止事件到审计日志

**系统影响**：
- **所有轴立即停止**
- 系统进入安全降级模式
- 拒绝后续的速度帧
- 需要复位才能重新启动

#### 复位命令 (Command = 3)
1. 清除降级/隔离状态
2. 重置安全管线
3. 清除错误标志
4. 恢复到正常模式
5. 记录复位事件

**系统影响**：
- 从降级/隔离状态恢复
- 允许重新启动系统
- 清除安全告警

#### 急停命令 (Command = 4)
1. 立即触发紧急停止
2. 所有轴速度设为 0（无斜坡）
3. 进入隔离模式
4. 禁用所有运动功能
5. 记录急停事件（最高优先级）

**系统影响**：
- **所有轴立即紧急停止**（响应时间 < 100ms）
- 系统进入最严格的隔离模式
- 所有运动功能禁用
- 需要手动复位才能恢复
- 触发安全告警通知

---

### 2. 查询安全 IO 配置
**GET** `/api/safety/io-configs`

**触发操作**：
- 从 LiteDB 读取物理安全按键配置
- 返回急停、启动、停止、复位按键的端口配置

**系统影响**：无副作用，仅读取操作

---

### 3. 更新安全 IO 配置
**PUT** `/api/safety/io-configs`

**触发操作**：
1. 验证端口号范围（-1 到 1000）
2. 验证轮询间隔（10-10000ms）
3. 持久化配置到 LiteDB
4. 重新初始化物理按键监听模块

**系统影响**：
- 物理按键映射立即生效
- 重启按键轮询服务（可能有短暂中断）
- 新配置持久化到数据库

---

## 上游通信 API

基础路径：`/api/upstream`

### 1. 查询上游连接配置
**GET** `/api/upstream/configs`

**触发操作**：
- 从 LiteDB 读取上游 TCP 连接参数
- 返回主机地址、端口、角色（Client/Server）等配置

**系统影响**：无副作用，仅读取操作

---

### 2. 更新上游连接配置
**PUT** `/api/upstream/configs`

**触发操作**：
1. 验证主机地址和端口有效性
2. 持久化新配置到 LiteDB
3. 可能触发连接重建（取决于实现）

**系统影响**：
- 上游连接参数更新
- 可能导致连接短暂中断
- 新配置在下次连接时生效

---

### 3. 查询上游连接状态
**GET** `/api/upstream/connections`

**触发操作**：
- 查询所有上游 TCP 连接的实时状态
- 返回每个连接的：
  - 连接状态（已连接/断开/连接中）
  - 传输角色（Client/Server）
  - 连接时长
  - 传输统计（字节数、帧数）

**系统影响**：无副作用，仅读取操作

---

### 4. 重新连接上游
**POST** `/api/upstream/connections/{index}/reconnect`

**触发操作**：
1. 关闭指定的上游连接
2. 清除连接状态
3. 重新建立 TCP 连接
4. 恢复数据传输

**系统影响**：
- 上游连接短暂中断（100-1000ms）
- 可能丢失正在传输的数据帧
- 连接恢复后继续接收数据
- 记录重连事件到日志

---

## 解码器 API

基础路径：`/api/decoder`

### 1. 健康检查
**GET** `/api/decoder/health`

**触发操作**：
- 检查解码器服务状态
- 验证上游连接是否正常
- 返回服务健康度指标

**系统影响**：无副作用，仅读取操作

---

### 2. 查询解码器配置
**GET** `/api/decoder/options`

**触发操作**：
- 从 LiteDB 读取解码器配置
- 返回厂商类型、协议版本等参数

**系统影响**：无副作用，仅读取操作

---

### 3. 更新解码器配置
**PUT** `/api/decoder/options`

**触发操作**：
1. 验证解码器参数
2. 持久化新配置到 LiteDB
3. 重新初始化解码器实例

**系统影响**：
- 解码器配置立即生效
- 可能导致短暂的解码中断
- 影响后续帧的解码逻辑

---

### 4. 在线解码帧
**POST** `/api/decoder/frames`

**触发操作**：
1. 接收原始字节流
2. 使用当前解码器解析数据
3. 返回解码后的结构化数据
4. 不影响实际运动控制（仅解码测试）

**系统影响**：
- 无副作用，不触发实际运动
- 用于调试和验证协议
- 记录解码测试到调试日志

---

## IO 监控 API

基础路径：`/api/iomonitor`

### 1. 查询 IO 监控配置
**GET** `/api/iomonitor/configs`

**触发操作**：
- 从 LiteDB 读取 IO 状态监控配置
- 返回输入/输出 IO 范围、轮询间隔、SignalR 频道等

**系统影响**：无副作用，仅读取操作

---

### 2. 更新 IO 监控配置
**PUT** `/api/iomonitor/configs`

**触发操作**：
1. 验证 IO 范围和轮询间隔
2. 持久化配置到 LiteDB
3. 重启 IO 状态监控后台服务

**系统影响**：
- IO 监控配置立即生效
- 后台服务重启（短暂中断）
- 新的轮询参数立即应用

---

### 3. 删除 IO 监控配置
**DELETE** `/api/iomonitor/configs`

**触发操作**：
- 删除 LiteDB 中的 IO 监控配置
- 停止 IO 状态监控服务

**系统影响**：
- IO 状态监控停止
- 不再广播 IO 状态
- 释放监控资源

---

## IO 状态 API

基础路径：`/api/io`

### 1. 查询所有 IO 状态
**GET** `/api/io/status`

**触发操作**：
1. 读取所有输入 IO 的当前状态（0/1）
2. 读取所有输出 IO 的当前状态（0/1）
3. 返回完整的 IO 状态快照

**系统影响**：无副作用，仅读取操作

**返回数据示例**：
```json
{
  "inputBits": [
    { "bitIndex": 0, "value": true, "isValid": true },
    { "bitIndex": 1, "value": false, "isValid": true }
  ],
  "outputBits": [
    { "bitIndex": 0, "value": true, "isValid": true }
  ]
}
```

---

## 系统会话 API

基础路径：`/api/system/session`

### 1. 释放系统会话（软重启）
**DELETE** `/api/system/session`

**触发操作**：
1. 停止所有后台服务（Workers）
2. 关闭所有上游连接
3. 断开 SignalR 客户端
4. 释放硬件资源
5. 清理内存和临时数据
6. **进程退出**

**系统影响**：
- **服务进程终止**（退出码 0）
- 所有连接断开
- 所有轴停止运动
- 需要外部部署脚本重启服务
- 用于配置更新后的重启场景

**注意事项**：
- 这是软重启机制，不会自动重启
- 需要配合进程管理器（systemd、supervisor、Docker 等）
- 调用前应保存重要状态
- 通常用于版本升级或重大配置变更

---

## SignalR 实时推送

SignalR Hub 路径：`/hubs/events`

系统会通过 SignalR 实时推送以下事件：

### 推送频道

1. **`axis.speed`** - 轴速度变化
   - 触发条件：轴速度发生变化
   - 推送频率：实时（变化时立即推送）
   - 数据格式：包含轴 ID 和新速度

2. **`safety.events`** - 安全事件
   - 触发条件：安全命令执行、状态变化
   - 推送内容：启动、停止、复位、急停事件

3. **`vision.decoded`** - 视觉解码帧
   - 触发条件：成功解码上游速度帧
   - 推送内容：帧序列号、速度数据统计

4. **`io.status`** - IO 状态变化（如果启用 IO 监控）
   - 触发条件：IO 状态定时轮询
   - 推送频率：按配置的轮询间隔

5. **`transport.events`** - 传输事件
   - 触发条件：上游连接状态变化、传输错误
   - 推送内容：连接/断开事件、错误信息

---

## 总结

### 高影响操作（需谨慎调用）

以下 API 会立即影响硬件运动或系统状态：

1. **POST** `/api/safety/commands` - 启动/停止/急停
2. **POST** `/api/axes/controller/reset` - 控制器复位
3. **POST** `/api/axes/axes/enable` - 使能轴（启动电机）
4. **POST** `/api/axes/axes/disable` - 禁用轴（释放电机）
5. **POST** `/api/axes/axes/speed` - 设置轴速度
6. **DELETE** `/api/system/session` - 系统软重启

### 配置更新操作（需要重启或重建服务）

1. **PUT** `/api/axes/controller/options` - 控制器配置
2. **PUT** `/api/axes/topology` - 轴网格布局
3. **PUT** `/api/safety/io-configs` - 安全 IO 配置
4. **PUT** `/api/upstream/configs` - 上游连接配置
5. **PUT** `/api/decoder/options` - 解码器配置
6. **PUT** `/api/iomonitor/configs` - IO 监控配置

### 只读查询操作（无副作用）

所有 **GET** 请求都是只读操作，不会改变系统状态。

---

## 最佳实践

1. **启动流程**：
   ```
   1. 检查系统状态 (GET /api/axes/controller)
   2. 清除错误 (DELETE /api/axes/controller/errors)
   3. 使能轴 (POST /api/axes/axes/enable)
   4. 发送启动命令 (POST /api/safety/commands, Command=1)
   5. 设置速度 (POST /api/axes/axes/speed)
   ```

2. **停止流程**：
   ```
   1. 发送停止命令 (POST /api/safety/commands, Command=2)
   2. 禁用轴（可选）(POST /api/axes/axes/disable)
   ```

3. **紧急停止**：
   ```
   1. 立即调用急停 (POST /api/safety/commands, Command=4)
   2. 检查系统状态
   3. 必要时复位 (POST /api/safety/commands, Command=3)
   ```

4. **配置更新**：
   ```
   1. 更新配置 (PUT /api/.../configs)
   2. 软重启系统 (DELETE /api/system/session)
   3. 等待外部脚本重启服务
   ```
