# ZakYip.Singulation 项目总览

## 🎯 最新更新（2025-11-07）

### ✅ 2025-11-07 配置验证增强和导入导出功能

本次更新增加了全面的配置验证和配置导入导出功能，提升配置管理的便利性和安全性：

#### 1. **配置验证增强** 🔍
- **新增验证工具类**：
  - `ConfigurationValidator` - 全面的配置验证工具类
  - 支持控制器配置、速度联动配置、IO 联动配置的详细验证
  - 提供友好的错误提示和警告信息
- **验证功能**：
  - ✅ 全面的数据注解验证（DataAnnotations）
  - ✅ 业务逻辑验证（传动机构、IP 地址格式等）
  - ✅ 重复项检测（重复的 IO 端口、重复的轴 ID）
  - ✅ 配置冲突检测（IO 端口在多个联动组中使用）
  - ✅ 格式化的错误和警告消息
  - ✅ 配置预检查功能
- **验证覆盖**：
  - 控制器配置验证：IP 地址、厂商标识、驱动参数模板
  - 速度联动配置验证：联动组、轴 ID、IO 端口
  - IO 联动配置验证：运行状态 IO、停止状态 IO
  - 驱动参数验证：传动机构、速度参数、健康监测参数
- **相关文件**：
  - `ConfigurationValidator.cs` - 核心验证工具类（430+ 行）
  - `SpeedLinkageController.cs` - 更新为使用增强验证
  - `IoLinkageController.cs` - 更新为使用增强验证

#### 2. **配置导入导出功能** 📦
- **新增导入导出服务**：
  - `ConfigurationImportExportService` - 配置导入导出服务
  - 支持 JSON 格式的配置序列化和反序列化
  - 提供配置包管理（版本、时间戳、描述）
- **导出功能**：
  - 导出所有配置到 JSON 字符串
  - 导出所有配置到文件
  - 下载配置文件（带时间戳文件名）
  - 单个配置类型导出
- **导入功能**：
  - 从 JSON 字符串导入配置
  - 从文件导入配置
  - 上传并导入配置文件
  - 验证模式（仅验证不导入）
  - 导入前自动进行完整验证
  - 详细的导入结果报告
- **配置模板功能**：
  - 提供预定义的配置模板
  - 支持控制器、速度联动、IO 联动和完整配置模板
  - 模板下载功能
  - 快速创建新配置
- **配置迁移工具**：
  - 支持配置的备份和恢复
  - 配置包版本管理
  - 批量配置导入导出
  - 配置历史追踪（导出时间戳）
- **相关文件**：
  - `ConfigurationImportExportService.cs` - 核心导入导出服务（430+ 行）
  - `ConfigurationController.cs` - REST API 控制器（340+ 行）
  - `Program.cs` - 注册配置导入导出服务

#### 3. **新增 API 端点** 🌐
- `GET /api/configurations/export` - 导出所有配置
- `GET /api/configurations/export/download` - 下载配置文件
- `POST /api/configurations/import` - 导入配置（支持验证模式）
- `POST /api/configurations/import/upload` - 上传并导入配置文件
- `GET /api/configurations/template` - 获取配置模板
- `GET /api/configurations/template/download` - 下载配置模板文件

#### 4. **使用示例** 📝

**导出配置**：
```bash
# 导出所有配置
GET /api/configurations/export?description=生产环境备份

# 下载配置文件
GET /api/configurations/export/download
```

**导入配置**：
```bash
# 验证配置（不实际导入）
POST /api/configurations/import?validateOnly=true
Content-Type: application/json
{ "version": "1.0.0", "controllerOptions": {...}, ... }

# 导入配置
POST /api/configurations/import
Content-Type: application/json
{ "version": "1.0.0", "controllerOptions": {...}, ... }
```

**获取模板**：
```bash
# 获取完整配置模板
GET /api/configurations/template?type=All

# 下载速度联动配置模板
GET /api/configurations/template/download?type=SpeedLinkage
```

#### 5. **优势** ✨
- ✅ 提升配置管理的安全性（导入前验证）
- ✅ 简化配置备份和恢复流程
- ✅ 支持配置模板，快速部署
- ✅ 友好的错误提示，降低配置错误
- ✅ 支持配置迁移，便于环境切换
- ✅ 详细的验证报告，帮助快速定位问题
- ✅ 配置版本管理，追踪配置变更历史

---

### ✅ 2025-11-07 性能优化：缓存、异步并发和内存分配

本次更新重点提升系统性能，减少数据库访问和优化并发IO操作：

#### 1. **配置缓存优化** 🚀
- **目标**：减少频繁访问配置时的数据库查询
- **实现**：
  - 为 `LiteDbControllerOptionsStore`、`LiteDbSpeedLinkageOptionsStore`、`LiteDbIoLinkageOptionsStore` 添加 IMemoryCache 支持
  - 配置缓存策略：绝对过期5分钟，滑动过期2分钟
  - 写入/删除操作时自动失效缓存
- **收益**：
  - 频繁读取配置时避免重复数据库访问
  - 提升配置查询响应速度
  - 减少磁盘I/O操作
- **相关文件**：
  - `LiteDbControllerOptionsStore.cs`
  - `LiteDbSpeedLinkageOptionsStore.cs`
  - `LiteDbIoLinkageOptionsStore.cs`
  - `Program.cs` - 注册 IMemoryCache 服务

#### 2. **异步并发优化** ⚡
- **IO 状态查询并行化**：
  - 重构 `IoStatusService.GetAllIoStatusAsync` 方法
  - 使用 `Parallel.For` 并行读取输入和输出 IO
  - 使用 `Task.WhenAll` 等待两个任务并行完成
  - 限制并发度为 8，避免资源耗尽
- **速度联动批量处理**：
  - 优化 `SpeedLinkageService` IO 写入流程
  - 先收集所有需要执行的 IO 写入操作
  - 使用 `Task.WhenAll` 批量并行执行
  - 减少等待时间，提高响应速度
- **收益**：
  - 大幅提升 IO 操作吞吐量
  - 减少总体响应时间
  - 提高系统并发处理能力
- **相关文件**：
  - `IoStatusService.cs`
  - `SpeedLinkageService.cs`

#### 3. **内存分配优化** 💾
- **ArrayPool 使用**：
  - 在 `IoStatusService` 中使用 `ArrayPool<int>.Shared` 租用/归还数组
  - 避免重复分配小对象
  - 减少 GC 压力
- **收益**：
  - 降低内存分配频率
  - 减少垃圾回收开销
  - 提升整体性能
- **相关文件**：
  - `IoStatusService.cs` - 添加 `using System.Buffers;`

#### 4. **测试更新** ✅
- 更新测试项目添加 `Microsoft.Extensions.Caching.Memory` 包
- 修复所有受影响的单元测试，添加缓存参数
- 所有测试通过验证

---


### ✅ 2025-11-04 代码重构：消除重复代码和提取供应商工具类

本次更新重点优化代码质量，消除重复代码，提取供应商特定的工具方法：

#### 1. **创建 LeadshineConversions 工具类** 🔧
- **新文件**：`LeadshineConversions.cs`
- **功能**：雷赛驱动器专用单位换算工具类
- **核心方法**：
  - `ComputeLinearPerRevolution` - 计算每转线位移 Lpr（丝杠导程或滚筒周长）
  - `LinearToLoadPps` - 通用转换：线速度/线加速度 → 负载侧脉冲频率/脉冲加速度
  - `LoadPpsToLinear` - 通用转换：负载侧脉冲 → 线速度/线加速度
  - `MmpsToLoadPps`, `LoadPpsToMmps` - 便捷方法：速度转换
  - `Mmps2ToLoadPps2`, `LoadPps2ToMmps2` - 便捷方法：加速度转换
- **优势**：
  - 消除了 LeadshineLtdmcAxisDrive 中 4 个重复意义的转换方法
  - 将速度和加速度转换统一为 2 个通用方法 + 4 个便捷重载
  - 提供清晰的供应商特定命名（Leadshine）

#### 2. **创建 LeadshinePdoHelpers 工具类** 🛠️
- **新文件**：`LeadshinePdoHelpers.cs`
- **功能**：雷赛 PDO 操作辅助工具类
- **核心方法**：
  - `WriteRxPdoWithPool` - 使用内存池写入单个 RxPDO
  - `ReadTxPdoWithPool` - 使用内存池读取单个 TxPDO
- **消除重复**：
  - 从 `LeadshineBatchPdoOperations.cs` 提取重复代码（~82 行）
  - 从 `LeadshineBatchOperationsEnhanced.cs` 提取重复代码（~82 行）
  - 共计消除 ~164 行完全相同的重复代码
- **优势**：
  - DRY 原则：避免在多个批量操作类中重复相同的 PDO 读写逻辑
  - 统一内存池管理：所有 PDO 操作使用相同的缓冲区租用/归还逻辑
  - 更易维护：修改 PDO 操作逻辑只需在一处更新

#### 3. **创建 LeadshineHelpers 工具类** 🔧
- **新文件**：`LeadshineHelpers.cs`
- **功能**：雷赛通用辅助工具类，集中小工具方法
- **核心方法**：
  - `FireEachNonBlocking` - 非阻塞事件广播（消除重复实现）
  - `ToStopwatchTicks` - TimeSpan 转 Stopwatch ticks
  - `EvState` - 事件状态封装结构体
- **消除重复**：
  - 之前 `FireEachNonBlocking` 在 LeadshineLtdmcAxisDrive 和 AxisEventAggregator 中有重复实现
  - 提取到统一位置，两处共享使用
- **优势**：
  - 小工具方法集中管理
  - 避免在多个类中重复相同的工具逻辑
  - 提供统一的事件广播和时间转换机制

#### 4. **重构统计** 📊
- **新增文件**：3 个工具类（332 行可复用代码）
  - LeadshineConversions.cs - 单位换算（112 行）
  - LeadshinePdoHelpers.cs - PDO 读写（143 行）
  - LeadshineHelpers.cs - 通用工具（77 行）
- **修改文件**：5 个（消除 ~240 行重复代码）
- **净收益**：代码行数略有增加，但可维护性和可复用性大幅提升

#### 5. **代码质量改进** ✅
- ✅ 消除重复代码：4 个转换方法 + 2 个 PDO 方法 + 1 个事件广播方法的重复
- ✅ 供应商命名规范：所有工具类文件以供应商命名（Leadshine）
- ✅ DRY 原则：避免重复实现相同功能
- ✅ 单一职责：每个工具类专注于特定领域（转换 vs PDO 操作 vs 通用工具）
- ✅ 可测试性：工具方法提取为静态公共方法，便于单元测试
- ✅ **工具集中**：小工具方法集中到专门的工具类，便于查找和复用

---

### ✅ 2025-11-04 代码质量优化和测试基础设施改进

本次更新重点优化代码质量和扩展测试基础设施：

#### 1. **DTO 类型优化** 📦
- **改进**：将所有可变 DTO 类转换为不可变 record class
- **优势**：
  - 提高数据不可变性，减少意外修改
  - 更好的线程安全性
  - 简化相等性比较
- **转换完成**：
  - `LinearPlannerParams` - 从 class 转换为 record class
  - `IoStatusResponseDto` - 从 class 转换为 record class
  - 更新相关使用代码以支持不可变初始化模式
- **相关文件**：
  - `LinearPlannerParams.cs` - 所有属性改为 init
  - `IoStatusResponseDto.cs` - 所有属性改为 init
  - `IoStatusService.cs` - 更新为使用对象初始化器模式

#### 2. **测试基础设施扩展** 🧪
- **新增测试辅助类**：
  - `FakeIoLinkageStore` - IO 联动配置存储的模拟实现
  - `FakeRuntimeStatusProvider` - 运行时状态提供者的模拟实现
  - 更新 `FakeCabinetIsolator` - 添加写入操作计数功能
- **用途**：为 Infrastructure 层和 Service 层单元测试提供基础
- **相关文件**：
  - `TestHelpers/FakeIoLinkageStore.cs`
  - `TestHelpers/FakeRuntimeStatusProvider.cs`
  - `TestHelpers/FakeCabinetIsolator.cs`

#### 3. **代码分析器配置** 🔍
- **已启用规则**：CA1031（捕获具体异常类型）设置为 warning 级别
- **配置位置**：`.editorconfig` 文件
- **影响范围**：帮助开发团队编写更健壮的异常处理代码

#### 4. **构建验证** ✅
- 验证所有项目（除 MAUI 外）成功编译
- 修复测试项目中 FakeAxisDrive 缺少 Ppr 属性的问题
- 确保代码变更不影响现有功能

---

### ✅ 2025-11-04 控制器查询和轴状态增强

本次更新增强了控制器查询接口和轴状态反馈的准确性：

#### 1. **控制器查询增加PPR数组** 📊
- **说明**：`GET /api/Axes/controller` 端点新增 `pps` 字段，返回所有轴的PPR（每转脉冲数）值数组
- **特性**：自动分组去重，如果所有轴都是同一个PPR则只返回一个元素，如果有不同的则返回多个不重复的值
- **用途**：便于上位机快速了解控制器中轴的PPR配置情况
- **相关文件**：
  - `ControllerResponseDto.cs` - 新增 `Pps` 属性
  - `AxesController.cs` - `GetController` 方法更新
  - `IAxisDrive.cs` - 新增 `Ppr` 只读属性
  - `LeadshineLtdmcAxisDrive.cs` - 实现 `Ppr` 属性

#### 2. **轴状态加减速度从SDK读取** 🔧
- **改进**：`GET /api/Axes/axes` 和 `GET /api/Axes/axes/{axisId}` 返回的 `MaxAccelMmps2` 和 `MaxDecelMmps2` 字段现从SDK实时读取
- **原理**：通过读取 0x6083（ProfileAcceleration）和 0x6084（ProfileDeceleration）寄存器获取当前设置值
- **优势**：
  - 反映驱动器实际配置的加减速度，而非本地缓存值
  - 更准确地反映轴的运行参数
  - 读取失败时自动回退到配置的最大值
- **相关文件**：
  - `LeadshineLtdmcAxisDrive.cs` - `MaxAccelMmps2` 和 `MaxDecelMmps2` 属性更新
  - `LeadshineProtocolMap.cs` - 支持读取加减速度寄存器
  - `ReadTxPdo` 方法 - 新增对 ProfileAcceleration 和 ProfileDeceleration 的支持

#### 3. **新增转换方法** 🧮
- **新增**：`LoadAccelPpsToMmps2` 方法用于将负载侧 pps² 转换为 mm/s²
- **说明**：与现有的 `LoadPpsToMmps`（速度转换）方法对应，用于加速度的单位转换
- **公式**：mm/s² = (pps² ÷ PPR) × Lpr


**工作原理**：
- 第一组：当轴1001和1002都停止时，IO 3和4设为高电平；当任一轴运动时，IO 3和4设为低电平
- 第二组：当轴1003和1004都停止时，IO 5和6设为高电平；当任一轴运动时，IO 5和6设为低电平

#### 3. API 端点
- `GET /api/io-linkage/speed/configs` - 获取速度联动配置
- `PUT /api/io-linkage/speed/configs` - 更新速度联动配置
- `DELETE /api/io-linkage/speed/configs` - 删除速度联动配置

#### 4. 技术实现
- **配置模型**：`SpeedLinkageOptions`, `SpeedLinkageGroup`, `SpeedLinkageIoPoint`
- **存储层**：`LiteDbSpeedLinkageOptionsStore` - 基于LiteDB的持久化存储
- **服务层**：`SpeedLinkageService` - 后台服务监控轴速度变化
- **控制器**：`SpeedLinkageController` - REST API控制器
- **单元测试**：完整的配置和存储测试覆盖

---

> 📝 **历史更新**：更多历史更新记录请查看 [CHANGELOG.md](CHANGELOG.md)


## 项目当前状态

### 📊 代码统计
- **总项目数**：9个
- **总源文件数**：~245个 (.cs, .xaml, .csproj)
- **代码行数**：~26,000行
- **编译状态**：✅ 成功（仅警告来自代码分析器建议）
- **架构质量**：✅ 符合Clean Architecture和DDD原则

### ⚙️ 技术栈
- **.NET 8.0** - 运行时框架
- **ASP.NET Core** - Web 框架
- **SignalR** - 实时通信
- **.NET MAUI 8.0.90** - 跨平台移动/桌面应用
- **Prism** - MVVM 框架和依赖注入
- **LiteDB** - 嵌入式数据库
- **Swagger/OpenAPI** - API 文档
- **雷赛 LTDMC** - 运动控制硬件

### 📈 项目完成度：约 90%

#### ✅ 已完成的核心功能
1. **核心控制层** (100%)：轴驱动、控制器聚合、事件系统、速度规划
2. **安全管理** (100%)：安全管线、隔离器、物理按键集成、远程/本地模式切换
3. **REST API** (100%)：完整的轴管理、安全控制、上游通信、IO联动API，含完整中文文档，新增控制器PPR查询
4. **SignalR 实时推送** (100%)：事件Hub、实时通知、队列管理
5. **雷赛驱动** (100%)：LTDMC 总线适配、轴驱动、协议映射，支持从SDK实时读取加减速度
6. **持久化** (100%)：LiteDB 存储、配置管理、对象映射
7. **后台服务** (100%)：心跳、日志泵、传输事件泵、IO联动服务、速度联动服务
8. **IO 联动** (100%)：系统状态联动、速度联动（新增）
9. **代码质量** (85%)：已完成 DTO record class 转换、代码分析器配置、值对象不可变性优化
10. **配置管理** (100%)：✨**新增** - 配置验证增强、配置导入导出、配置模板、配置迁移工具
11. **文档** (98%)：API文档、架构设计、运维指南、代码质量优化记录
12. **MAUI 客户端** (80%)：基础功能完成，需要完善UI和用户体验

#### ⚠️ 待完善的部分
- **测试覆盖** (60%)：基础单元测试完成，测试辅助类已扩展，需要更多集成测试和端到端测试
- **部署运维** (30%)：缺少容器化、CI/CD、监控告警
- **MAUI应用** (80%)：需要完善应用图标、深色主题等

---

## 接下来的优化方向

### 🎯 核心优化重点

基于当前项目90%完成度，以下优化方向按优先级排序，旨在提升系统的生产就绪度、可靠性和可维护性。

---

### 🚀 短期优化（1-2周）- 高优先级

#### 1. 代码质量与健壮性提升 ⭐⭐⭐
- [x] 评估更多 DTO 类转换为 record class 的机会（已完成：LinearPlannerParams, IoStatusResponseDto）
- [x] 识别可以转换为 readonly struct 的小型值对象（已完成：已有多个值对象使用 readonly record struct）
- [x] 启用并配置代码分析器规则（已启用 CA1031 等规则，设置为 warning 级别）
- [x] 统一注释语言为中文（已完成：所有源代码英文注释已翻译为中文）
- [ ] **统一异常处理策略** ⚡ 紧急
  - 定义异常处理最佳实践文档（包含示例代码）
  - 审查所有 catch 块，避免捕获通用 Exception
  - 在所有层级实施一致的异常处理模式
  - 添加自定义业务异常类型（AxisOperationException, SafetyViolationException 等）
  - 实现异常分类和智能重试策略（区分瞬时故障和永久故障）
  - 添加异常聚合和上报机制
- [ ] **优化日志记录规范** ⚡ 紧急
  - 统一日志级别使用标准（Debug/Info/Warning/Error/Critical）
  - 为高频操作实施日志采样策略（如每100次记录一次）
  - 添加结构化日志最佳实践（使用 LoggerMessage Source Generator）
  - 实现敏感信息脱敏机制
  - 添加关键业务指标日志（轴操作、安全事件、IO联动触发）
  - 配置日志轮转和归档策略
- [ ] **修复测试项目中的空引用警告**
  - 为测试方法添加适当的空值检查或断言
  - 使用 null-forgiving 操作符（!）消除已验证的误报
  - 启用可空引用类型检查（Nullable Enable）

#### 2. 性能优化与监控 ⭐⭐⭐
- [ ] **关键路径性能优化** ⚡ 紧急
  - 优化轴速度监控频率（当前100ms轮询）
    - 实现基于事件驱动的速度变化通知机制
    - 添加可配置的采样间隔（默认100ms，可调整至50-500ms）
    - 实现智能采样：静止时降低频率，运动时提高频率
  - 优化加减速度读取机制
    - 实现加减速度参数的本地缓存（TTL: 5秒）
    - 定期后台刷新缓存，避免查询时阻塞
    - 提供强制刷新接口用于配置变更后立即同步
  - IO操作批处理优化
    - 实现 IO 写入缓冲队列（批量提交间隔：10ms）
    - 合并同一周期内的多个 IO 写入请求
    - 减少硬件调用次数，降低延迟
  - 内存分配优化
    - 扩大 ArrayPool 使用范围（PDO 操作、日志缓冲）
    - 使用 Span<T> 和 Memory<T> 减少不必要的数组拷贝
    - 监控和优化高频路径的小对象分配
- [ ] **应用性能监控（APM）集成**
  - 集成 Application Insights 或 Elastic APM
  - 实现分布式追踪（Trace ID 跨所有日志和请求）
  - 监控关键指标：
    - 轴操作响应时间（P50、P95、P99）
    - IO 联动触发延迟
    - API 请求吞吐量和错误率
    - 数据库查询性能
  - 配置性能基线和告警阈值
- [ ] **数据库性能优化**
  - LiteDB 索引优化
    - 为频繁查询的字段添加索引（AxisId, BatchId, Timestamp）
    - 分析慢查询并优化查询语句
  - 实现查询结果缓存（内存缓存 + 过期策略）
  - 配置数据库连接池和并发访问策略

#### 3. 测试覆盖率提升 ⭐⭐
- [x] 速度联动功能单元测试
- [x] Infrastructure层单元测试扩展（已添加测试辅助类：FakeIoLinkageStore, FakeRuntimeStatusProvider）
- [ ] **单元测试完善** ⚡ 高优先级
  - Core 层单元测试（目标覆盖率：80%+）
    - LeadshineLtdmcAxisDrive 核心方法测试
    - AxisEventAggregator 事件聚合测试
    - LinearPlanner 规划算法测试
  - Infrastructure 层单元测试（目标覆盖率：70%+）
    - LiteDB 存储层测试（CRUD 操作）
    - 配置映射测试
    - IO 联动服务测试
- [ ] **集成测试开发**
  - Controllers REST API 集成测试
    - 所有端点的正常流程测试
    - 错误处理和边界条件测试
    - 请求验证和响应格式验证
  - Safety Pipeline 端到端测试
    - 完整安全隔离流程测试
    - 故障场景模拟（硬件断线、通信超时）
    - 恢复流程验证
- [ ] **性能基准测试**
  - 批量操作性能基准（10/50/100轴同时操作）
  - 内存分配和 GC 压力监控
  - 建立性能回归检测机制（CI集成）
  - 长时间运行稳定性测试（24小时+）
#### 4. 核心功能增强 ⭐⭐
- [x] 速度联动配置功能
- [x] 控制器PPR数组查询功能
- [x] 轴状态加减速度从SDK实时读取
- [ ] **IO联动功能完善**
  - 速度联动延迟触发
    - 添加可配置的触发延迟时间（防抖：100-1000ms）
    - 实现防抖和节流机制，避免瞬间速度波动误触发
  - 速度阈值配置
    - 支持自定义速度阈值（替代固定的0值判断）
    - 支持多级速度区间配置（低速/中速/高速）
    - 实现速度范围触发条件
  - IO联动历史记录
    - 持久化联动事件日志（时间戳、触发条件、IO状态）
    - 提供历史查询 API（分页、筛选）
    - 实现事件重放功能用于故障分析
  - 配置热重载
    - 实现配置变更通知机制（IOptionsMonitor）
    - 支持配置即时生效，无需重启服务
    - 提供配置回滚功能
- [ ] **监控和诊断增强**
  - 实时监控仪表板
    - 轴速度、位置实时曲线图（SignalR 推送）
    - IO 状态实时变化可视化
    - 系统健康度评分（基于错误率、响应时间等）
  - PPR变化监控
    - 检测和记录 PPR 值的变化
    - 记录变化历史和原因（配置更新、硬件替换）
    - 提供异常检测和告警
  - 智能故障诊断
    - 实现常见故障的自动诊断规则
    - 提供故障解决建议和操作指引
    - 集成故障知识库
- [ ] **批量操作优化**
  - 批量轴参数读取 API
    - 一次性批量读取所有轴的状态参数
    - 优化网络往返次数
    - 支持参数选择性读取
  - 轴组管理功能
    - 支持将多个轴分组管理（定义轴组）
    - 实现组级别的批量操作（启用/禁用/设速）
    - 提供组间协调功能（同步启动、顺序停止）

### 🌟 中期规划（2-4周）- 中优先级

#### 1. 生产环境部署准备 ⭐⭐⭐
- [ ] **容器化配置** ⚡ 高优先级
  - 创建多阶段 Dockerfile
    - Build 阶段：.NET SDK 8.0 完整构建
    - Runtime 阶段：ASP.NET Runtime 最小化镜像
    - 优化镜像大小（目标：<200MB）
  - Docker Compose 配置
    - 定义服务依赖关系（应用、数据库、日志）
    - 配置数据卷持久化（LiteDB、日志）
    - 网络隔离和端口映射
  - 容器安全配置
    - 非 root 用户运行
    - 只读根文件系统
    - 资源限制（CPU、内存）
    - 安全扫描（Trivy、Grype）
- [ ] **Kubernetes 部署**
  - 编写 K8s 资源清单
    - Deployment：滚动更新策略、副本数配置
    - Service：负载均衡和服务发现
    - ConfigMap：配置文件外部化
    - Secret：敏感信息加密存储
  - 健康检查配置
    - Liveness Probe：检测死锁和崩溃
    - Readiness Probe：检测服务就绪状态
    - Startup Probe：处理慢启动场景
  - 资源管理
    - Request/Limit 设置（CPU、内存）
    - HPA 自动扩缩容配置
    - PVC 持久化存储配置
- [ ] **健康检查完善**
  - 组件级健康检查
    - 数据库连接状态
    - 雷赛 LTDMC 通信状态
    - SignalR Hub 连接状态
    - 后台服务运行状态
  - 健康度评分
    - 综合评估各组件状态
    - 提供详细的诊断信息
    - 趋势分析和预警
- [ ] **配置管理优化**
  - 环境变量支持
    - 所有配置项支持环境变量覆盖
    - 配置优先级：环境变量 > appsettings.{env}.json > appsettings.json
  - 配置中心集成（可选）
    - 支持 Consul、etcd 等配置中心
    - 实现配置热更新机制
    - 配置变更审计

#### 2. 可观测性体系建设 ⭐⭐⭐
- [ ] **监控大盘（Prometheus + Grafana）** ⚡ 高优先级
  - Prometheus 指标导出
    - 业务指标：轴操作次数、IO联动触发次数、批次处理数量
    - 性能指标：API响应时间分布、PDO操作延迟
    - 系统指标：CPU、内存、GC统计、线程池状态
  - Grafana 可视化面板
    - 系统总览面板（健康状态、关键指标）
    - 轴运行监控面板（速度、位置、状态）
    - IO联动监控面板（触发频率、延迟分布）
    - 性能分析面板（响应时间热图、错误率趋势）
  - 告警规则配置
    - 关键指标阈值告警（响应时间P95 > 500ms）
    - 错误率告警（错误率 > 1%）
    - 资源使用告警（内存使用 > 80%）
- [ ] **日志聚合（ELK 或 Loki）**
  - 日志收集配置
    - Filebeat/Promtail 日志采集
    - 结构化日志格式（JSON）
    - 日志级别和来源标签
  - 日志存储和索引
    - Elasticsearch/Loki 存储配置
    - 索引策略（按日期轮转）
    - 保留策略（30天热数据，90天温数据）
  - 日志分析界面
    - Kibana/Grafana Loki 查询界面
    - 预定义查询模板（错误日志、慢操作）
    - 日志统计和趋势分析
- [ ] **告警通知集成**
  - 多渠道告警支持
    - 邮件告警（SMTP）
    - 短信告警（阿里云SMS）
    - 即时通讯告警（钉钉、企业微信）
  - 告警分级和升级
    - P0（严重）：立即通知，电话告警
    - P1（重要）：5分钟内通知
    - P2（警告）：汇总通知
  - 告警收敛和去重
    - 同一告警5分钟内只发送一次
    - 关联告警合并
  - 告警历史查询
    - 告警事件记录
    - 处理状态跟踪
    - 告警统计分析

#### 3. CI/CD 自动化流水线 ⭐⭐
- [ ] **GitHub Actions 构建流水线**
  - 自动化构建
    - 代码推送自动触发构建
    - 多平台构建（Linux、Windows）
    - 构建产物上传（Artifacts）
  - 代码质量检查
    - SonarQube 静态代码分析
    - 代码覆盖率报告生成
    - 依赖安全扫描（Dependabot）
  - 自动化测试
    - PR 提交自动运行单元测试
    - 每日定时运行集成测试
    - 测试报告自动生成和发布
- [ ] **容器镜像自动发布**
  - 镜像构建自动化
    - 标签推送触发镜像构建
    - 多架构镜像（amd64、arm64）
    - 镜像优化和压缩
  - 镜像安全扫描
    - Trivy/Grype 漏洞扫描
    - 基础镜像定期更新
    - 扫描报告和阻断策略
  - 镜像仓库管理
    - Docker Hub/Harbor 推送
    - 镜像标签策略（latest、版本号、SHA）
    - 镜像清理策略
- [ ] **版本管理和发布**
  - 语义化版本控制（SemVer）
    - 主版本.次版本.补丁版本
    - 预发布版本标记（alpha、beta、rc）
  - 自动化发布流程
    - 基于标签自动创建 Release
    - 自动生成变更日志（Changelog）
    - 发布说明自动填充
  - 发布审批流程
    - PR Review 机制
    - 发布前检查清单
    - 回滚预案

#### 4. MAUI 移动应用完善 ⭐⭐
- [ ] **用户体验优化**
  - UI/UX 改进
    - 响应式布局优化
    - 加载状态指示
    - 错误提示友好化
  - 深色主题支持
    - 深色/浅色主题切换
    - 遵循系统主题设置
    - 主题切换动画
  - 应用图标和启动屏
    - 设计专业应用图标
    - 启动屏幕品牌化
    - 自适应图标（Android）
- [ ] **功能完善**
  - IO联动配置界面
    - 图形化配置 IO 联动规则
    - 拖拽式操作
    - 配置预览和验证
  - 速度联动配置界面
    - 可视化速度阈值设置
    - 联动关系图形化展示
    - 配置模板和快速向导
  - 历史数据查询
    - 事件日志查询和筛选
    - 数据导出（CSV/Excel）
    - 图表可视化
- [ ] **离线模式支持**
  - 本地数据缓存
  - 离线操作队列
  - 网络恢复后自动同步
- [ ] **推送通知**
  - 关键事件推送
  - 告警通知
  - 通知历史管理

### 🎯 长期规划（1-3个月）- 低优先级

#### 1. 安全加固体系 ⭐⭐⭐
- [ ] **身份认证和授权**
  - JWT Token 认证
    - 实现基于 JWT 的用户认证
    - Token 刷新机制（Refresh Token）
    - Token 撤销和黑名单管理
    - Token 安全存储（HttpOnly Cookie）
  - 角色权限管理（RBAC）
    - 定义角色模型（管理员、操作员、观察员）
    - 细粒度权限控制（操作级别）
    - 权限继承和组合
    - 权限管理 UI 界面
  - 多因素认证（MFA）
    - TOTP 两步验证
    - 短信验证码
    - 生物识别（移动端）
- [ ] **安全审计**
  - 审计日志系统
    - 记录所有敏感操作（配置修改、控制命令、用户登录）
    - 审计日志不可篡改存储
    - 操作人员、时间戳、操作内容详细记录
  - 审计日志查询
    - 按用户、操作类型、时间范围查询
    - 审计报告生成
    - 审计日志导出
  - 合规性报告
    - 定期生成合规性报告
    - 安全事件统计分析
- [ ] **API 安全防护**
  - 请求频率限制（Rate Limiting）
    - 基于 IP 的限流
    - 基于用户的限流
    - 不同端点不同限流策略
    - 限流告警和封禁
  - API 网关集成
    - 统一入口和路由
    - 请求验证和转换
    - 响应缓存
  - DDoS 防护
    - 流量清洗
    - 异常流量检测
    - IP 黑白名单
- [ ] **数据安全**
  - 敏感数据加密
    - 数据库字段级加密
    - 配置文件加密存储
    - 传输层 TLS 加密
  - 数据脱敏
    - 日志中的敏感信息脱敏
    - 开发环境数据脱敏
  - 备份加密
    - 备份文件加密存储
    - 密钥管理和轮转

#### 2. 高可用架构演进 ⭐⭐⭐
- [ ] **水平扩展能力**
  - 无状态化改造
    - 会话状态外部化（Redis）
    - 静态资源 CDN 加速
    - 配置中心化管理
  - 负载均衡
    - Nginx/HAProxy 配置
    - 健康检查和故障转移
    - 会话保持策略
    - 负载均衡算法选择（轮询、最少连接、IP哈希）
  - 服务发现
    - Consul/etcd 服务注册
    - 动态服务发现
    - 客户端负载均衡
- [ ] **容错和韧性**
  - 熔断器模式（增强）
    - Polly 熔断策略配置
    - 熔断状态监控
    - 自动恢复机制
  - 服务降级
    - 定义降级策略
    - 降级开关配置
    - 降级状态通知
  - 重试策略优化
    - 指数退避重试
    - 幂等性保证
    - 重试次数限制
  - 超时控制
    - 统一超时策略
    - 级联超时处理
    - 超时监控和告警
- [ ] **分布式部署**
  - 跨数据中心部署
    - 多区域部署策略
    - 数据同步方案
    - 故障隔离
  - 数据一致性
    - 分布式事务处理
    - 最终一致性保证
    - 冲突解决策略
  - 网络优化
    - 延迟优化
    - 带宽管理
    - 传输压缩
- [ ] **灾备方案**
  - 备份策略
    - 定期全量备份
    - 增量备份
    - 异地备份
  - 灾难恢复计划（DRP）
    - RTO/RPO 定义
    - 恢复流程文档
    - 定期演练
  - 双活/多活架构
    - 双活数据中心
    - 流量智能调度
    - 数据双向同步

#### 3. 智能化和数据分析 ⭐⭐
- [ ] **数据可视化增强**
  - 实时数据可视化
    - 轴速度、位置实时曲线图
    - IO 状态时序图
    - 多轴运动轨迹可视化
  - 历史数据分析
    - 历史趋势分析
    - 数据对比功能
    - 统计报表生成
  - 自定义仪表板
    - 拖拽式仪表板设计器
    - 预定义模板
    - 个性化配置保存
- [ ] **预测性维护**
  - 设备健康监控
    - 关键参数趋势监控
    - 异常模式识别
    - 健康度评分
  - 故障预测
    - 基于历史数据的故障预测模型
    - 提前告警和维护建议
    - 预测准确度持续优化
  - 维护计划
    - 维护任务管理
    - 维护记录追踪
    - 维护效果评估
- [ ] **智能优化**
  - 参数自优化
    - 基于运行数据的参数优化建议
    - A/B 测试功能
    - 最优参数组合推荐
  - 能耗优化
    - 能耗监控和分析
    - 节能运行模式
    - 能效评估报告
  - 生产效率分析
    - 吞吐量统计
    - 瓶颈识别
    - 效率提升建议
- [ ] **机器学习集成**
  - 异常检测
    - 基于 ML 的异常行为检测
    - 自适应阈值调整
    - 异常根因分析
  - 质量预测
    - 产品质量预测模型
    - 关键参数相关性分析
    - 质量改进建议

#### 4. 用户体验和国际化 ⭐
- [ ] **多语言支持**
  - 国际化框架
    - 实现 i18n 基础设施
    - 资源文件管理（中文、英文）
    - 语言切换功能
  - 本地化内容
    - UI 文本本地化
    - 日期时间格式本地化
    - 数字和货币格式本地化
  - 语言检测
    - 自动检测用户语言偏好
    - 浏览器语言设置
    - 用户手动切换
- [ ] **帮助和文档系统**
  - 在线帮助
    - 上下文相关帮助
    - 操作向导和提示
    - 常见问题解答（FAQ）
  - 视频教程
    - 功能演示视频
    - 操作指南视频
    - 故障排查视频
  - 知识库
    - 分类知识文章
    - 搜索功能
    - 用户反馈和评价
- [ ] **用户反馈机制**
  - 问题反馈
    - 应用内问题报告
    - 自动附带诊断信息
    - 反馈状态跟踪
  - 功能建议
    - 建议提交和投票
    - 开发路线图公开
    - 用户参与讨论
  - 满意度调查
    - 定期满意度调查
    - NPS 评分
    - 改进措施跟踪

---

### 📈 性能优化专项

#### 关键性能指标（KPI）目标
| 指标 | 当前值 | 目标值 | 优先级 |
|------|--------|--------|--------|
| API 响应时间 P95 | - | <200ms | ⭐⭐⭐ |
| IO 联动触发延迟 | 100ms | <50ms | ⭐⭐⭐ |
| 轴操作响应时间 | - | <100ms | ⭐⭐⭐ |
| 系统启动时间 | - | <5s | ⭐⭐ |
| 内存占用 | - | <500MB | ⭐⭐ |
| CPU 使用率（空闲） | - | <10% | ⭐⭐ |
| 并发连接数 | - | >1000 | ⭐ |

#### 性能优化措施
1. **轴速度监控优化**
   - 当前：100ms 固定轮询
   - 优化：事件驱动 + 自适应采样
   - 预期收益：CPU 使用率降低 30%

2. **IO 批处理优化**
   - 当前：单次写入
   - 优化：10ms 批处理窗口
   - 预期收益：IO 延迟降低 50%

3. **内存分配优化**
   - 当前：频繁小对象分配
   - 优化：ArrayPool + Span<T>
   - 预期收益：GC 压力降低 40%

4. **数据库查询优化**
   - 当前：无索引
   - 优化：添加索引 + 查询缓存
   - 预期收益：查询响应时间降低 60%

5. **加减速度读取优化**
   - 当前：每次从 SDK 读取
   - 优化：5秒 TTL 缓存
   - 预期收益：查询响应时间降低 80%

---

### 🔒 安全加固专项

#### 安全威胁模型（STRIDE）
| 威胁类型 | 风险等级 | 缓解措施 | 优先级 |
|----------|----------|----------|--------|
| 身份伪装 | 高 | JWT 认证 + MFA | ⭐⭐⭐ |
| 数据篡改 | 高 | TLS 加密 + 数字签名 | ⭐⭐⭐ |
| 否认操作 | 中 | 审计日志 | ⭐⭐ |
| 信息泄露 | 高 | 数据加密 + 脱敏 | ⭐⭐⭐ |
| 拒绝服务 | 中 | Rate Limiting + DDoS 防护 | ⭐⭐ |
| 权限提升 | 高 | RBAC + 最小权限原则 | ⭐⭐⭐ |

#### 安全检查清单
- [ ] **认证和授权**
  - [ ] 实施强密码策略
  - [ ] 启用 MFA
  - [ ] 实现 RBAC
  - [ ] Token 安全管理
  
- [ ] **数据安全**
  - [ ] 传输层 TLS 加密
  - [ ] 敏感数据字段加密
  - [ ] 日志脱敏
  - [ ] 备份加密

- [ ] **网络安全**
  - [ ] API Rate Limiting
  - [ ] IP 白名单
  - [ ] DDoS 防护
  - [ ] 防火墙规则

- [ ] **应用安全**
  - [ ] 输入验证
  - [ ] SQL 注入防护
  - [ ] XSS 防护
  - [ ] CSRF 防护

- [ ] **运维安全**
  - [ ] 最小权限原则
  - [ ] 定期安全审计
  - [ ] 漏洞扫描
  - [ ] 安全更新

---

### 🧪 测试策略专项

#### 测试金字塔
```
        /\
       /E2E\        端到端测试 (10%)
      /------\
     /  集成   \     集成测试 (30%)
    /----------\
   /    单元     \   单元测试 (60%)
  /--------------\
```

#### 测试覆盖率目标
| 层次 | 目标覆盖率 | 当前覆盖率 | 优先级 |
|------|-----------|-----------|--------|
| Core 层 | 80%+ | - | ⭐⭐⭐ |
| Infrastructure 层 | 70%+ | - | ⭐⭐⭐ |
| Host 层 (Controllers) | 60%+ | - | ⭐⭐ |
| Drivers 层 | 50%+ | - | ⭐ |

#### 测试类型
1. **单元测试**
   - 业务逻辑测试
   - 边界条件测试
   - 异常处理测试

2. **集成测试**
   - API 端点测试
   - 数据库集成测试
   - 服务集成测试

3. **性能测试**
   - 负载测试
   - 压力测试
   - 稳定性测试

4. **安全测试**
   - 渗透测试
   - 漏洞扫描
   - 依赖安全检查

5. **端到端测试**
   - 关键业务流程测试
   - 用户场景测试
   - 跨系统集成测试

---

## 可优化的功能

### 性能优化
1. **轴速度监控频率**：当前100ms轮询，可考虑改为事件驱动模式
   - 实现轴速度变化事件通知机制
   - 减少不必要的轮询开销
   - 提供可配置的采样间隔
2. **IO写入批处理**：当多个联动组同时触发时，可批量写入IO以减少硬件调用
   - 实现 IO 写入缓冲和批量提交
   - 优化高频 IO 操作场景
   - 减少硬件访问延迟
3. **缓存优化**：为频繁访问的配置添加内存缓存
   - 使用 IMemoryCache 缓存配置数据
   - 实现缓存失效和更新策略
   - 减少数据库访问次数
4. **异步并发优化**：某些IO操作可以并行执行以提高响应速度
   - 识别可并行的 IO 操作
   - 使用 Task.WhenAll 并行执行
   - 控制并发度以避免资源耗尽
5. **加减速度读取优化**：当前每次查询都从SDK读取，可考虑添加缓存机制并定期刷新
   - 实现加减速度参数的本地缓存
   - 定期或按需刷新缓存
   - 提供强制刷新接口
6. **内存分配优化**
   - 减少小对象分配和 GC 压力
   - 扩大 ArrayPool 的使用范围
   - 使用 Span<T> 和 Memory<T> 减少拷贝
7. **数据库查询优化**
   - 添加适当的索引
   - 优化复杂查询语句
   - 实现查询结果缓存

### 功能增强
1. **速度联动延迟触发**：添加延迟配置，避免瞬间速度波动导致的误触发
   - 支持配置触发延迟时间
   - 实现防抖和节流机制
   - 提供灵敏度调节选项
2. **速度阈值配置**：支持配置速度阈值而非固定的0值判断
   - 允许设置自定义速度阈值
   - 支持多级速度区间配置
   - 实现速度范围触发
3. **联动组优先级**：支持配置联动组的优先级和互斥关系
   - 定义联动组优先级机制
   - 实现互斥组功能
   - 支持条件性联动
4. **IO联动历史记录**：记录IO联动触发历史，便于故障排查
   - 持久化联动事件日志
   - 提供历史查询和统计
   - 实现事件重放功能
5. **配置热重载**：配置更新无需等待下次检查周期即可生效
   - 实现配置变更通知机制
   - 支持即时应用新配置
   - 提供配置回滚功能
6. **PPR变化监控**：检测和记录PPR值的变化，用于诊断配置问题
   - 监控 PPR 值的变化
   - 记录变化历史和原因
   - 提供异常检测和告警
7. **批量轴参数读取**：支持一次性批量读取所有轴的加减速度等参数
   - 实现批量读取 API
   - 优化网络往返次数
   - 提高参数查询性能
8. **智能故障诊断**
   - 实现常见故障的自动诊断
   - 提供故障解决建议
   - 集成故障知识库
9. **轴组管理**
   - 支持将多个轴分组管理
   - 实现组级别的批量操作
   - 提供组间协调功能

### 用户体验
1. **配置验证增强**：✅ **已完成** - 添加更详细的配置验证，提供友好的错误提示
   - ✅ 实现全面的配置校验规则
   - ✅ 提供详细的验证错误信息
   - ✅ 支持配置预检查
2. **配置导入导出**：✅ **已完成** - 支持配置的JSON文件导入导出
   - ✅ 实现配置序列化和反序列化
   - ✅ 支持配置模板功能
   - ✅ 提供配置迁移工具
3. **可视化配置界面**：在MAUI应用中提供图形化配置界面
   - 设计直观的配置界面
   - 支持拖拽式操作
   - 提供配置向导
4. **实时状态监控**：显示各联动组的当前状态和触发历史
   - 实时显示联动状态
   - 可视化触发历史
   - 提供状态统计图表
5. **帮助文档集成**
   - 在应用中集成帮助文档
   - 提供上下文相关的帮助
   - 添加视频教程链接
6. **操作引导和提示**
   - 新手引导流程
   - 操作提示和建议
   - 快捷键支持

### 可靠性
1. **异常恢复机制**：IO写入失败时的重试策略
   - 实现智能重试机制
   - 配置重试次数和间隔
   - 提供失败回调处理
2. **配置版本管理**：支持配置回滚到历史版本
   - 保存配置变更历史
   - 支持版本对比
   - 实现一键回滚
3. **健康检查**：为速度联动服务添加专门的健康检查端点
   - 监控服务运行状态
   - 检测潜在问题
   - 提供健康度评分
4. **监控告警**：联动服务异常时发送告警通知
   - 实现多渠道告警（邮件、短信、钉钉等）
   - 支持告警规则配置
   - 提供告警历史查询
5. **数据备份自动化**
   - 定时自动备份关键数据
   - 实现增量备份
   - 提供备份验证功能
6. **故障自愈**
   - 实现自动故障检测
   - 支持部分故障场景的自动恢复
   - 记录自愈操作日志

---

## 构建与运行

### 前置要求
- .NET 8.0 SDK
- Visual Studio 2022 或 VS Code
- 雷赛 LTDMC 驱动（用于硬件控制）

### 构建整个解决方案
```bash
# 恢复依赖
dotnet restore

# 构建所有项目（除MAUI外）
dotnet build

# 运行测试
dotnet test
```

### 运行 Host 服务
```bash
cd ZakYip.Singulation.Host
dotnet run
```
服务将在 http://localhost:5005 启动

**访问地址**：
- **Swagger 文档**：http://localhost:5005/swagger
- **健康检查**：http://localhost:5005/health
- **SignalR Hub**：ws://localhost:5005/hubs/events

---

## 📚 文档资源

### 核心文档
- [架构设计](docs/ARCHITECTURE.md)
- [API 文档](docs/API.md)
- [API 操作说明](docs/API_OPERATIONS.md)
- [安全按键快速入门](docs/SAFETY_QUICK_START.md)
- [安全按键完整指南](docs/SAFETY_BUTTONS.md)

### 运维文档
- [运维手册](ops/OPERATIONS_MANUAL.md)
- [配置指南](ops/CONFIGURATION_GUIDE.md)
- [部署运维手册](docs/DEPLOYMENT.md)
- [故障排查手册](docs/TROUBLESHOOTING.md)
- [备份恢复流程](ops/BACKUP_RECOVERY.md)
- [应急响应预案](ops/EMERGENCY_RESPONSE.md)

### 开发文档
- [开发指南](docs/DEVELOPER_GUIDE.md)
- [MAUI 应用说明](docs/MAUIAPP.md)
- [图标字体指南](docs/ICON_FONT_GUIDE.md)
- [性能优化](docs/PERFORMANCE.md)
- [完整更新历史](docs/CHANGELOG.md)

---

## 许可证
（待定）

## 贡献指南

欢迎提交问题和拉取请求！在贡献代码时，请遵循以下准则：

### 代码规范
1. **优先使用枚举**：能使用枚举的地方尽量使用枚举代替int/string
2. **使用不可变类型**：配置和DTO优先使用record class
3. **中文注释和文档**：所有注释和文档必须使用中文
4. **代码变更必须同步更新文档**
5. **提交信息请使用中文**

### 测试要求
- 新功能必须包含单元测试
- 修复bug必须包含回归测试
- 测试覆盖率应保持在合理水平

### 提交流程
1. Fork 项目
2. 创建功能分支
3. 提交代码和测试
4. 确保所有测试通过
5. 提交 Pull Request
