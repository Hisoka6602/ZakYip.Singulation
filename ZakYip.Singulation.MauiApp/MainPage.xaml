<?xml version="1.0" encoding="utf-8" ?>
<ContentPage
    x:Class="ZakYip.Singulation.MauiApp.MainPage"
    xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
    xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
    xmlns:controls="clr-namespace:ZakYip.Singulation.MauiApp.Controls"
    xmlns:services="clr-namespace:ZakYip.Singulation.MauiApp.Services"
    xmlns:icons="clr-namespace:ZakYip.Singulation.MauiApp.Icons"
    xmlns:viewmodels="clr-namespace:ZakYip.Singulation.MauiApp.ViewModels"
    Title="分件助手"
    x:DataType="viewmodels:MainViewModel"
    BackgroundColor="#F4F6FA">

    <Grid>
        <RefreshView
            Command="{Binding RefreshControllersCommand}"
            IsRefreshing="{Binding IsLoading}"
            RefreshColor="#2563EB">
            <ScrollView>
                <VerticalStackLayout Padding="24,32" Spacing="24">

                    <VerticalStackLayout Spacing="6">
                        <Label
                            FontAttributes="Bold"
                            FontSize="28"
                            SemanticProperties.HeadingLevel="Level1"
                            Text="分件助手"
                            TextColor="#1A1F36" />
                        <Label
                            FontSize="14"
                            Text="{Binding MachineSerialDisplay}"
                            TextColor="#64748B" />
                        <Label
                            FontSize="12"
                            Text="{Binding StatusMessage}"
                            TextColor="#94A3B8" />
                    </VerticalStackLayout>

                    <Frame
                        Padding="20"
                        BackgroundColor="White"
                        BorderColor="#E2E8F0"
                        CornerRadius="20"
                        HasShadow="False">
                        <Grid
                            ColumnDefinitions="*,*"
                            ColumnSpacing="16"
                            RowDefinitions="Auto,Auto"
                            RowSpacing="16">
                            <Border
                                Grid.Row="0"
                                Grid.Column="0"
                                Padding="16"
                                BackgroundColor="#F8FAFF"
                                Stroke="#E2E8F0"
                                StrokeThickness="1">
                                <Border.StrokeShape>
                                    <RoundRectangle CornerRadius="16" />
                                </Border.StrokeShape>
                                <Border.GestureRecognizers>
                                    <TapGestureRecognizer Command="{Binding RefreshControllersCommand}" />
                                </Border.GestureRecognizers>
                                <Grid ColumnDefinitions="Auto,*" ColumnSpacing="12">
                                    <Border
                                        Padding="10"
                                        BackgroundColor="#E0E7FF"
                                        CornerRadius="16">
                                        <Label
                                            FontAttributes="Bold"
                                            FontFamily="{x:Static icons:IconFont.FASolid}"
                                            FontSize="16"
                                            HorizontalTextAlignment="Center"
                                            Text="{Binding RefreshGlyph}"
                                            TextColor="#2563EB" />
                                    </Border>
                                    <VerticalStackLayout Spacing="6">
                                        <Label
                                            FontAttributes="Bold"
                                            FontSize="16"
                                            Text="刷新控制器"
                                            TextColor="#0F172A" />
                                        <HorizontalStackLayout Spacing="8">
                                            <Label
                                                FontSize="12"
                                                Text="自动刷新"
                                                TextColor="#64748B"
                                                VerticalOptions="Center" />
                                            <Switch
                                                IsEnabled="{Binding IsLoading, Converter={StaticResource InvertedBoolConverter}}"
                                                IsToggled="{Binding IsAutoRefreshEnabled}"
                                                OnColor="#2563EB"
                                                SemanticProperties.Description="Toggle auto-refresh for controllers"
                                                ThumbColor="White" />
                                        </HorizontalStackLayout>
                                    </VerticalStackLayout>
                                </Grid>
                            </Border>

                            <Border
                                Grid.Row="0"
                                Grid.Column="1"
                                Padding="16"
                                BackgroundColor="#2563EB"
                                Stroke="#1D4ED8"
                                StrokeThickness="1">
                                <Border.StrokeShape>
                                    <RoundRectangle CornerRadius="16" />
                                </Border.StrokeShape>
                                <Border.GestureRecognizers>
                                    <TapGestureRecognizer Command="{Binding ToggleSafetyPanelCommand}" />
                                </Border.GestureRecognizers>
                                <Grid ColumnDefinitions="Auto,*" ColumnSpacing="12">
                                    <Border
                                        Padding="10"
                                        BackgroundColor="#1E3A8A"
                                        CornerRadius="16">
                                        <Label
                                            FontAttributes="Bold"
                                            FontFamily="{x:Static icons:IconFont.FASolid}"
                                            FontSize="16"
                                            HorizontalTextAlignment="Center"
                                            Text="{Binding SafetyGlyph}"
                                            TextColor="White" />
                                    </Border>
                                    <VerticalStackLayout Spacing="4">
                                        <Label
                                            FontAttributes="Bold"
                                            FontSize="16"
                                            Text="安全指令"
                                            TextColor="White" />
                                        <Label
                                            FontSize="12"
                                            Text="选择命令类型"
                                            TextColor="#E0E7FF" />
                                    </VerticalStackLayout>
                                </Grid>
                            </Border>

                            <Border
                                Grid.Row="1"
                                Grid.Column="0"
                                Padding="16"
                                BackgroundColor="#ECFDF5"
                                Stroke="#A7F3D0"
                                StrokeThickness="1">
                                <Border.StrokeShape>
                                    <RoundRectangle CornerRadius="16" />
                                </Border.StrokeShape>
                                <Grid ColumnDefinitions="Auto,*" ColumnSpacing="12">
                                    <Border
                                        Padding="10"
                                        BackgroundColor="#D1FAE5"
                                        CornerRadius="16">
                                        <Label
                                            FontAttributes="Bold"
                                            FontFamily="{x:Static icons:IconFont.FASolid}"
                                            FontSize="16"
                                            HorizontalTextAlignment="Center"
                                            Text="{Binding PlayGlyph}"
                                            TextColor="#047857" />
                                    </Border>
                                    <VerticalStackLayout Spacing="6">
                                        <Label
                                            FontAttributes="Bold"
                                            FontSize="16"
                                            Text="全部使能"
                                            TextColor="#065F46" />
                                        <HorizontalStackLayout Spacing="8">
                                            <Label
                                                FontSize="12"
                                                Text="同步启停"
                                                TextColor="#0F172A"
                                                VerticalOptions="Center" />
                                            <Switch
                                                IsEnabled="{Binding IsLoading, Converter={StaticResource InvertedBoolConverter}}"
                                                IsToggled="{Binding AreAllAxesEnabled}"
                                                OnColor="#10B981"
                                                SemanticProperties.Description="Toggle to enable or disable all axes"
                                                ThumbColor="White" />
                                        </HorizontalStackLayout>
                                    </VerticalStackLayout>
                                </Grid>
                            </Border>

                            <Border
                                Grid.Row="1"
                                Grid.Column="1"
                                Padding="16"
                                BackgroundColor="#F8FAFF"
                                Stroke="#CBD5F5"
                                StrokeThickness="1">
                                <Border.StrokeShape>
                                    <RoundRectangle CornerRadius="16" />
                                </Border.StrokeShape>
                                <Border.GestureRecognizers>
                                    <TapGestureRecognizer Command="{Binding ToggleSpeedPanelCommand}" />
                                </Border.GestureRecognizers>
                                <Grid ColumnDefinitions="Auto,*" ColumnSpacing="12">
                                    <Border
                                        Padding="10"
                                        BackgroundColor="#E0E7FF"
                                        CornerRadius="16">
                                        <Label
                                            FontAttributes="Bold"
                                            FontFamily="{x:Static icons:IconFont.FASolid}"
                                            FontSize="16"
                                            HorizontalTextAlignment="Center"
                                            Text="{Binding SpeedGlyph}"
                                            TextColor="#1E3A8A" />
                                    </Border>
                                    <VerticalStackLayout Spacing="4">
                                        <Label
                                            FontAttributes="Bold"
                                            FontSize="16"
                                            Text="输速设定"
                                            TextColor="#1E293B" />
                                        <Label
                                            FontSize="12"
                                            Text="批量调整目标值"
                                            TextColor="#64748B" />
                                    </VerticalStackLayout>
                                </Grid>
                            </Border>
                        </Grid>
                    </Frame>

                    <Border
                        Padding="20"
                        BackgroundColor="White"
                        IsVisible="{Binding IsSafetyPanelVisible}"
                        Stroke="#E2E8F0"
                        StrokeThickness="1">
                        <Border.StrokeShape>
                            <RoundRectangle CornerRadius="18" />
                        </Border.StrokeShape>
                        <VerticalStackLayout Spacing="12">
                            <HorizontalStackLayout Spacing="8">
                                <Label
                                    FontAttributes="Bold"
                                    FontSize="18"
                                    Text="安全命令"
                                    TextColor="#1A1F36" />
                                <Label
                                    FontSize="12"
                                    Text="（选择命令类型与原因）"
                                    TextColor="#94A3B8" />
                            </HorizontalStackLayout>

                            <Grid ColumnDefinitions="Auto,*" ColumnSpacing="12">
                                <Label
                                    Grid.Column="0"
                                    FontSize="14"
                                    Text="命令类型"
                                    TextColor="#1A1F36"
                                    VerticalOptions="Center" />
                                <Picker
                                    Title="选择命令类型"
                                    Grid.Column="1"
                                    BackgroundColor="#F8FAFF"
                                    SelectedItem="{Binding SafetyCommandType}">
                                    <Picker.ItemsSource>
                                        <x:Array Type="{x:Type x:String}">
                                            <x:String>Start</x:String>
                                            <x:String>Stop</x:String>
                                            <x:String>Reset</x:String>
                                        </x:Array>
                                    </Picker.ItemsSource>
                                </Picker>
                            </Grid>

                            <Grid ColumnDefinitions="Auto,*" ColumnSpacing="12">
                                <Label
                                    Grid.Column="0"
                                    FontSize="14"
                                    Text="命令原因"
                                    TextColor="#1A1F36"
                                    VerticalOptions="Center" />
                                <Entry
                                    Grid.Column="1"
                                    BackgroundColor="#F8FAFF"
                                    Placeholder="输入命令原因（可选）"
                                    Text="{Binding SafetyReason}" />
                            </Grid>

                            <Button
                                BackgroundColor="#2563EB"
                                Command="{Binding SendSafetyCommandCommand}"
                                CornerRadius="12"
                                FontAttributes="Bold"
                                HeightRequest="48"
                                IsEnabled="{Binding IsLoading, Converter={StaticResource InvertedBoolConverter}}"
                                Text="发送安全命令"
                                TextColor="White" />
                        </VerticalStackLayout>
                    </Border>

                    <Border
                        Padding="20"
                        BackgroundColor="White"
                        IsVisible="{Binding IsSpeedPanelVisible}"
                        Stroke="#E2E8F0"
                        StrokeThickness="1">
                        <Border.StrokeShape>
                            <RoundRectangle CornerRadius="18" />
                        </Border.StrokeShape>
                        <VerticalStackLayout Spacing="12">
                            <HorizontalStackLayout Spacing="8">
                                <Label
                                    FontAttributes="Bold"
                                    FontSize="18"
                                    Text="速度设定"
                                    TextColor="#1A1F36" />
                                <Label
                                    FontSize="12"
                                    Text="（设置所有轴目标速度）"
                                    TextColor="#94A3B8" />
                            </HorizontalStackLayout>

                            <Grid ColumnDefinitions="*,Auto" ColumnSpacing="12">
                                <Entry
                                    Grid.Column="0"
                                    BackgroundColor="#F8FAFF"
                                    Keyboard="Numeric"
                                    Placeholder="100"
                                    Text="{Binding TargetSpeed}" />
                                <Button
                                    Grid.Column="1"
                                    BackgroundColor="#22C55E"
                                    Command="{Binding SetAllAxesSpeedCommand}"
                                    CornerRadius="12"
                                    FontAttributes="Bold"
                                    HeightRequest="48"
                                    IsEnabled="{Binding IsLoading, Converter={StaticResource InvertedBoolConverter}}"
                                    Text="应用"
                                    TextColor="White"
                                    WidthRequest="100" />
                            </Grid>
                        </VerticalStackLayout>
                    </Border>

                    <CollectionView
                        HeightRequest="{OnIdiom Phone=520,
                                                Tablet=600,
                                                Desktop=680}"
                        ItemsSource="{Binding Controllers}"
                        SelectionMode="None">
                        <CollectionView.ItemsLayout>
                            <GridItemsLayout
                                HorizontalItemSpacing="16"
                                Orientation="Vertical"
                                Span="3"
                                VerticalItemSpacing="16" />
                        </CollectionView.ItemsLayout>

                        <CollectionView.EmptyView>
                            <VerticalStackLayout
                                Padding="40"
                                HorizontalOptions="Center"
                                Spacing="12">
                                <Label
                                    FontAttributes="Bold"
                                    FontSize="18"
                                    Text="暂无轴数据"
                                    TextColor="#94A3B8" />
                                <Label
                                    FontSize="14"
                                    HorizontalTextAlignment="Center"
                                    Text="点击上方刷新按钮或启用自动刷新"
                                    TextColor="#A0AEC0" />
                            </VerticalStackLayout>
                        </CollectionView.EmptyView>

                        <CollectionView.ItemTemplate>
                            <DataTemplate x:DataType="services:AxisInfo">
                                <Border
                                    Padding="18"
                                    BackgroundColor="White"
                                    Stroke="#E2E8F0"
                                    StrokeThickness="1">
                                    <Border.StrokeShape>
                                        <RoundRectangle CornerRadius="18" />
                                    </Border.StrokeShape>
                                    <Border.GestureRecognizers>
                                        <TapGestureRecognizer Command="{Binding Source={RelativeSource AncestorType={x:Type viewmodels:MainViewModel}}, Path=ViewDetailsCommand}" CommandParameter="{Binding .}" />
                                    </Border.GestureRecognizers>

                                    <VerticalStackLayout Spacing="16">
                                        <Grid ColumnDefinitions="Auto,*" ColumnSpacing="8">
                                            <Label
                                                Grid.Column="0"
                                                FontAttributes="Bold"
                                                FontSize="18"
                                                Text="{Binding AxisId}"
                                                TextColor="#1A1F36" />
                                            <Frame
                                                Grid.Column="1"
                                                Padding="8,4"
                                                BackgroundColor="#EEF2FF"
                                                CornerRadius="12"
                                                HorizontalOptions="End">
                                                <Label
                                                    FontSize="12"
                                                    Text="{Binding StatusText}"
                                                    TextColor="#3730A3" />
                                            </Frame>
                                        </Grid>

                                        <VerticalStackLayout Spacing="4">
                                            <Label
                                                FontAttributes="Bold"
                                                FontSize="28"
                                                Text="{Binding CurrentSpeed, StringFormat='{0:F0} r/min'}"
                                                TextColor="#2563EB" />
                                            <Label
                                                FontSize="12"
                                                IsVisible="{Binding TargetLinearMmps, Converter={StaticResource StringToBoolConverter}}"
                                                Text="{Binding TargetLinearMmps, StringFormat='目标: {0:F1} mm/s'}"
                                                TextColor="#64748B" />
                                            <Label
                                                FontSize="12"
                                                Text="{Binding Enabled, Converter={StaticResource BoolToTextConverter}, ConverterParameter='已使能:未使能'}"
                                                TextColor="#1A1F36" />
                                        </VerticalStackLayout>
                                    </VerticalStackLayout>
                                </Border>
                            </DataTemplate>
                        </CollectionView.ItemTemplate>
                    </CollectionView>

                    <Frame
                        Padding="16"
                        BackgroundColor="White"
                        BorderColor="#E2E8F0"
                        CornerRadius="18"
                        HasShadow="False">
                        <Grid ColumnDefinitions="Auto,*,Auto" ColumnSpacing="12">
                            <Label
                                FontAttributes="Bold"
                                FontSize="14"
                                Text="SignalR 状态"
                                TextColor="#1A1F36" />
                            <Label
                                Grid.Column="1"
                                FontSize="14"
                                Text="{Binding SignalRStatus}"
                                TextColor="#2563EB" />
                            <Label
                                Grid.Column="2"
                                FontSize="12"
                                Text="{Binding SignalRLatencyText}"
                                TextColor="#94A3B8" />
                        </Grid>
                    </Frame>
                </VerticalStackLayout>
            </ScrollView>
        </RefreshView>

        <controls:NotificationOverlay
            Margin="0,10,0,0"
            HorizontalOptions="Fill"
            VerticalOptions="Start"
            ZIndex="1000" />
    </Grid>
</ContentPage>