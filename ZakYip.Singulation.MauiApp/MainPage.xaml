<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:viewmodels="clr-namespace:ZakYip.Singulation.MauiApp.ViewModels"
             xmlns:services="clr-namespace:ZakYip.Singulation.MauiApp.Services"
             xmlns:controls="clr-namespace:ZakYip.Singulation.MauiApp.Controls"
             x:Class="ZakYip.Singulation.MauiApp.MainPage"
             x:DataType="viewmodels:MainViewModel"
             Title="åˆ†ä»¶åŠ©æ‰‹"
             BackgroundColor="#F4F6FA">

    <Grid>
        <RefreshView
            IsRefreshing="{Binding IsLoading}"
            Command="{Binding RefreshControllersCommand}"
            RefreshColor="#2563EB">
            <ScrollView>
                <VerticalStackLayout
                    Padding="24,32"
                    Spacing="24">

                    <VerticalStackLayout Spacing="6">
                        <Label
                            Text="åˆ†ä»¶åŠ©æ‰‹"
                            FontSize="28"
                            FontAttributes="Bold"
                            TextColor="#1A1F36"
                            SemanticProperties.HeadingLevel="Level1" />
                        <Label
                            Text="{Binding MachineSerialDisplay}"
                            FontSize="14"
                            TextColor="#64748B" />
                        <Label
                            Text="{Binding StatusMessage}"
                            FontSize="12"
                            TextColor="#94A3B8" />
                    </VerticalStackLayout>

                    <Frame
                        Padding="20"
                        BackgroundColor="White"
                        CornerRadius="20"
                        BorderColor="#E2E8F0"
                        HasShadow="False">
                        <Grid RowSpacing="16">
                            <Grid.RowDefinitions>
                                <RowDefinition Height="Auto" />
                            </Grid.RowDefinitions>

                            <Grid
                                ColumnSpacing="12"
                                ColumnDefinitions="*,*,*,*">
                                <Border
                                    Grid.Column="0"
                                    Padding="16"
                                    BackgroundColor="#F8FAFF"
                                    Stroke="#E2E8F0"
                                    StrokeThickness="1">
                                    <Border.StrokeShape>
                                        <RoundRectangle CornerRadius="16" />
                                    </Border.StrokeShape>
                                    <Border.Triggers>
                                        <DataTrigger
                                            TargetType="Border"
                                            Binding="{Binding IsAutoRefreshEnabled}"
                                            Value="True">
                                            <Setter Property="BackgroundColor" Value="#E0F2FE" />
                                            <Setter Property="Stroke" Value="#60A5FA" />
                                        </DataTrigger>
                                    </Border.Triggers>
                                    <Border.GestureRecognizers>
                                        <TapGestureRecognizer Command="{Binding ToggleAutoRefreshCommand}" />
                                    </Border.GestureRecognizers>
                                    <Grid ColumnDefinitions="Auto,*,Auto" ColumnSpacing="12" VerticalOptions="Center">
                                        <Frame
                                            Grid.Column="0"
                                            BackgroundColor="#DBEAFE"
                                            Padding="8"
                                            CornerRadius="12"
                                            HasShadow="False">
                                            <Label
                                                Text="â†»"
                                                FontSize="20"
                                                TextColor="#2563EB"
                                                HorizontalTextAlignment="Center"
                                                VerticalTextAlignment="Center" />
                                        </Frame>
                                        <VerticalStackLayout Grid.Column="1" Spacing="4">
                                            <Label
                                                Text="åˆ·æ–°æŽ§åˆ¶å™¨"
                                                FontAttributes="Bold"
                                                FontSize="14"
                                                TextColor="#1A1F36" />
                                            <Label
                                                Text="{Binding AutoRefreshStatusText}"
                                                FontSize="12"
                                                TextColor="#64748B" />
                                        </VerticalStackLayout>
                                        <Switch
                                            Grid.Column="2"
                                            IsToggled="{Binding IsAutoRefreshEnabled}"
                                            IsEnabled="{Binding IsLoading, Converter={StaticResource InvertedBoolConverter}}"
                                            OnColor="#2563EB"
                                            ThumbColor="White" />
                                    </Grid>
                                </Border>

                                <Border
                                    Grid.Column="1"
                                    Padding="16"
                                    BackgroundColor="#2563EB"
                                    Stroke="#2563EB"
                                    StrokeThickness="1">
                                    <Border.StrokeShape>
                                        <RoundRectangle CornerRadius="16" />
                                    </Border.StrokeShape>
                                    <Border.GestureRecognizers>
                                        <TapGestureRecognizer Command="{Binding ToggleSafetyPanelCommand}" />
                                    </Border.GestureRecognizers>
                                    <Grid ColumnDefinitions="Auto,*" ColumnSpacing="12" VerticalOptions="Center">
                                        <Frame
                                            Grid.Column="0"
                                            BackgroundColor="#1D4ED8"
                                            Padding="8"
                                            CornerRadius="12"
                                            HasShadow="False">
                                            <Label
                                                Text="ðŸ›¡ï¸"
                                                FontSize="20"
                                                HorizontalTextAlignment="Center"
                                                VerticalTextAlignment="Center" />
                                        </Frame>
                                        <VerticalStackLayout Grid.Column="1" Spacing="4">
                                            <Label
                                                Text="å®‰å…¨æŒ‡ä»¤"
                                                FontAttributes="Bold"
                                                FontSize="14"
                                                TextColor="White" />
                                            <Label
                                                Text="æ‰“å¼€å®‰å…¨å‘½ä»¤é¢æ¿"
                                                FontSize="12"
                                                TextColor="#DBEAFE" />
                                        </VerticalStackLayout>
                                    </Grid>
                                </Border>

                                <Border
                                    Grid.Column="2"
                                    Padding="16"
                                    BackgroundColor="#F8FAFF"
                                    Stroke="#E2E8F0"
                                    StrokeThickness="1">
                                    <Border.StrokeShape>
                                        <RoundRectangle CornerRadius="16" />
                                    </Border.StrokeShape>
                                    <Border.Triggers>
                                        <DataTrigger
                                            TargetType="Border"
                                            Binding="{Binding AreAllAxesEnabled}"
                                            Value="True">
                                            <Setter Property="BackgroundColor" Value="#DCFCE7" />
                                            <Setter Property="Stroke" Value="#34D399" />
                                        </DataTrigger>
                                    </Border.Triggers>
                                    <Border.GestureRecognizers>
                                        <TapGestureRecognizer Command="{Binding ToggleAllAxesCommand}" />
                                    </Border.GestureRecognizers>
                                    <Grid ColumnDefinitions="Auto,*,Auto" ColumnSpacing="12" VerticalOptions="Center">
                                        <Frame
                                            Grid.Column="0"
                                            BackgroundColor="#D1FAE5"
                                            Padding="8"
                                            CornerRadius="12"
                                            HasShadow="False">
                                            <Label
                                                Text="âš™ï¸"
                                                FontSize="20"
                                                HorizontalTextAlignment="Center"
                                                VerticalTextAlignment="Center" />
                                        </Frame>
                                        <VerticalStackLayout Grid.Column="1" Spacing="4">
                                            <Label
                                                Text="å…¨éƒ¨ä½¿èƒ½"
                                                FontAttributes="Bold"
                                                FontSize="14"
                                                TextColor="#1A1F36" />
                                            <Label
                                                Text="{Binding AllAxesStatusText}"
                                                FontSize="12"
                                                TextColor="#64748B" />
                                        </VerticalStackLayout>
                                        <Switch
                                            Grid.Column="2"
                                            IsToggled="{Binding AreAllAxesEnabled}"
                                            IsEnabled="{Binding IsLoading, Converter={StaticResource InvertedBoolConverter}}"
                                            OnColor="#22C55E"
                                            ThumbColor="White" />
                                    </Grid>
                                </Border>

                                <Border
                                    Grid.Column="3"
                                    Padding="16"
                                    BackgroundColor="#F1F5F9"
                                    Stroke="#CBD5F5"
                                    StrokeThickness="1">
                                    <Border.StrokeShape>
                                        <RoundRectangle CornerRadius="16" />
                                    </Border.StrokeShape>
                                    <Border.GestureRecognizers>
                                        <TapGestureRecognizer Command="{Binding ToggleSpeedPanelCommand}" />
                                    </Border.GestureRecognizers>
                                    <Grid ColumnDefinitions="Auto,*" ColumnSpacing="12" VerticalOptions="Center">
                                        <Frame
                                            Grid.Column="0"
                                            BackgroundColor="#E2E8F0"
                                            Padding="8"
                                            CornerRadius="12"
                                            HasShadow="False">
                                            <Label
                                                Text="â±ï¸"
                                                FontSize="20"
                                                HorizontalTextAlignment="Center"
                                                VerticalTextAlignment="Center" />
                                        </Frame>
                                        <VerticalStackLayout Grid.Column="1" Spacing="4">
                                            <Label
                                                Text="è¾“é€Ÿè®¾å®š"
                                                FontAttributes="Bold"
                                                FontSize="14"
                                                TextColor="#1E293B" />
                                            <Label
                                                Text="æ‰¹é‡è®¾ç½®è½´é€Ÿåº¦"
                                                FontSize="12"
                                                TextColor="#64748B" />
                                        </VerticalStackLayout>
                                    </Grid>
                                </Border>
                            </Grid>
                        </Grid>
                    </Frame>

                    <Border
                        IsVisible="{Binding IsSafetyPanelVisible}"
                        BackgroundColor="White"
                        Stroke="#E2E8F0"
                        Padding="20"
                        StrokeThickness="1">
                        <Border.StrokeShape>
                            <RoundRectangle CornerRadius="18" />
                        </Border.StrokeShape>
                        <VerticalStackLayout Spacing="12">
                            <HorizontalStackLayout Spacing="8">
                                <Label
                                    Text="å®‰å…¨å‘½ä»¤"
                                    FontSize="18"
                                    FontAttributes="Bold"
                                    TextColor="#1A1F36" />
                                <Label
                                    Text="ï¼ˆé€‰æ‹©å‘½ä»¤ç±»åž‹ä¸ŽåŽŸå› ï¼‰"
                                    FontSize="12"
                                    TextColor="#94A3B8" />
                            </HorizontalStackLayout>

                            <Grid ColumnDefinitions="Auto,*" ColumnSpacing="12">
                                <Label
                                    Grid.Column="0"
                                    Text="å‘½ä»¤ç±»åž‹"
                                    FontSize="14"
                                    VerticalOptions="Center"
                                    TextColor="#1A1F36" />
                                <Picker
                                    Grid.Column="1"
                                    Title="é€‰æ‹©å‘½ä»¤ç±»åž‹"
                                    SelectedItem="{Binding SafetyCommandType}"
                                    BackgroundColor="#F8FAFF">
                                    <Picker.ItemsSource>
                                        <x:Array Type="{x:Type x:String}">
                                            <x:String>Start</x:String>
                                            <x:String>Stop</x:String>
                                            <x:String>Reset</x:String>
                                        </x:Array>
                                    </Picker.ItemsSource>
                                </Picker>
                            </Grid>

                            <Grid ColumnDefinitions="Auto,*" ColumnSpacing="12">
                                <Label
                                    Grid.Column="0"
                                    Text="å‘½ä»¤åŽŸå› "
                                    FontSize="14"
                                    VerticalOptions="Center"
                                    TextColor="#1A1F36" />
                                <Entry
                                    Grid.Column="1"
                                    Placeholder="è¾“å…¥å‘½ä»¤åŽŸå› ï¼ˆå¯é€‰ï¼‰"
                                    Text="{Binding SafetyReason}"
                                    BackgroundColor="#F8FAFF" />
                            </Grid>

                            <Button
                                Text="å‘é€å®‰å…¨å‘½ä»¤"
                                Command="{Binding SendSafetyCommandCommand}"
                                IsEnabled="{Binding IsLoading, Converter={StaticResource InvertedBoolConverter}}"
                                BackgroundColor="#2563EB"
                                TextColor="White"
                                CornerRadius="12"
                                FontAttributes="Bold"
                                HeightRequest="48" />
                        </VerticalStackLayout>
                    </Border>

                    <Border
                        IsVisible="{Binding IsSpeedPanelVisible}"
                        BackgroundColor="White"
                        Stroke="#E2E8F0"
                        Padding="20"
                        StrokeThickness="1">
                        <Border.StrokeShape>
                            <RoundRectangle CornerRadius="18" />
                        </Border.StrokeShape>
                        <VerticalStackLayout Spacing="12">
                            <HorizontalStackLayout Spacing="8">
                                <Label
                                    Text="é€Ÿåº¦è®¾å®š"
                                    FontSize="18"
                                    FontAttributes="Bold"
                                    TextColor="#1A1F36" />
                                <Label
                                    Text="ï¼ˆè®¾ç½®æ‰€æœ‰è½´ç›®æ ‡é€Ÿåº¦ï¼‰"
                                    FontSize="12"
                                    TextColor="#94A3B8" />
                            </HorizontalStackLayout>

                            <Grid ColumnDefinitions="*,Auto" ColumnSpacing="12">
                                <Entry
                                    Grid.Column="0"
                                    Text="{Binding TargetSpeed}"
                                    Placeholder="100"
                                    Keyboard="Numeric"
                                    BackgroundColor="#F8FAFF" />
                                <Button
                                    Grid.Column="1"
                                    Text="åº”ç”¨"
                                    Command="{Binding SetAllAxesSpeedCommand}"
                                    IsEnabled="{Binding IsLoading, Converter={StaticResource InvertedBoolConverter}}"
                                    BackgroundColor="#22C55E"
                                    TextColor="White"
                                    CornerRadius="12"
                                    FontAttributes="Bold"
                                    HeightRequest="48"
                                    WidthRequest="100" />
                            </Grid>
                        </VerticalStackLayout>
                    </Border>

                    <CollectionView
                        ItemsSource="{Binding Controllers}"
                        SelectionMode="None"
                        HeightRequest="{OnIdiom Phone=520, Tablet=600, Desktop=680}">
                        <CollectionView.ItemsLayout>
                            <GridItemsLayout
                                Orientation="Vertical"
                                Span="3"
                                HorizontalItemSpacing="16"
                                VerticalItemSpacing="16" />
                        </CollectionView.ItemsLayout>

                        <CollectionView.EmptyView>
                            <VerticalStackLayout
                                Padding="40"
                                Spacing="12"
                                HorizontalOptions="Center">
                                <Label
                                    Text="æš‚æ— è½´æ•°æ®"
                                    FontSize="18"
                                    FontAttributes="Bold"
                                    TextColor="#94A3B8" />
                                <Label
                                    Text="ç‚¹å‡»ä¸Šæ–¹åˆ·æ–°æŒ‰é’®æˆ–å¯ç”¨è‡ªåŠ¨åˆ·æ–°"
                                    FontSize="14"
                                    TextColor="#A0AEC0"
                                    HorizontalTextAlignment="Center" />
                            </VerticalStackLayout>
                        </CollectionView.EmptyView>

                        <CollectionView.ItemTemplate>
                            <DataTemplate x:DataType="services:AxisInfo">
                                <Border
                                    Stroke="#E2E8F0"
                                    StrokeThickness="1"
                                    BackgroundColor="White"
                                    Padding="18">
                                    <Border.StrokeShape>
                                        <RoundRectangle CornerRadius="18" />
                                    </Border.StrokeShape>
                                    <Border.GestureRecognizers>
                                        <TapGestureRecognizer
                                            Command="{Binding Source={RelativeSource AncestorType={x:Type viewmodels:MainViewModel}}, Path=ViewDetailsCommand}"
                                            CommandParameter="{Binding .}" />
                                    </Border.GestureRecognizers>

                                    <VerticalStackLayout Spacing="16">
                                        <Grid ColumnDefinitions="Auto,*" ColumnSpacing="8">
                                            <Label
                                                Grid.Column="0"
                                                Text="{Binding AxisId}"
                                                FontSize="18"
                                                FontAttributes="Bold"
                                                TextColor="#1A1F36" />
                                            <Frame
                                                Grid.Column="1"
                                                Padding="8,4"
                                                BackgroundColor="#EEF2FF"
                                                CornerRadius="12"
                                                HorizontalOptions="End">
                                                <Label
                                                    Text="{Binding StatusText}"
                                                    FontSize="12"
                                                    TextColor="#3730A3" />
                                            </Frame>
                                        </Grid>

                                        <VerticalStackLayout Spacing="4">
                                            <Label
                                                Text="{Binding CurrentRpm, StringFormat='{0:F0} r/min'}"
                                                FontSize="28"
                                                FontAttributes="Bold"
                                                TextColor="#2563EB" />
                                            <Label
                                                Text="{Binding TargetLinearMmps, StringFormat='ç›®æ ‡: {0:F1} mm/s'}"
                                                FontSize="12"
                                                TextColor="#64748B"
                                                IsVisible="{Binding TargetLinearMmps, Converter={StaticResource StringToBoolConverter}}" />
                                            <Label
                                                Text="{Binding Enabled, Converter={StaticResource BoolToTextConverter}, ConverterParameter='å·²ä½¿èƒ½:æœªä½¿èƒ½'}"
                                                FontSize="12"
                                                TextColor="#1A1F36" />
                                        </VerticalStackLayout>
                                    </VerticalStackLayout>
                                </Border>
                            </DataTemplate>
                        </CollectionView.ItemTemplate>
                    </CollectionView>

                    <Frame
                        Padding="16"
                        BackgroundColor="White"
                        CornerRadius="18"
                        BorderColor="#E2E8F0"
                        HasShadow="False">
                        <Grid ColumnDefinitions="Auto,*,Auto" ColumnSpacing="12">
                            <Label
                                Text="SignalR çŠ¶æ€"
                                FontSize="14"
                                FontAttributes="Bold"
                                TextColor="#1A1F36" />
                            <Label
                                Grid.Column="1"
                                Text="{Binding SignalRStatus}"
                                FontSize="14"
                                TextColor="#2563EB" />
                            <Label
                                Grid.Column="2"
                                Text="{Binding SignalRLatencyText}"
                                FontSize="12"
                                TextColor="#94A3B8" />
                        </Grid>
                    </Frame>
                </VerticalStackLayout>
            </ScrollView>
        </RefreshView>

        <controls:NotificationOverlay
            VerticalOptions="Start"
            HorizontalOptions="Fill"
            Margin="0,10,0,0"
            ZIndex="1000" />
    </Grid>
</ContentPage>
